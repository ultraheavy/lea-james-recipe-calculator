{% extends "base_modern.html" %}
{% block title %}Edit Menu - {{ menu.menu_name }}{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="content-header">
        <h1>Edit Menu: {{ menu.menu_name }}</h1>
        <a href="{{ url_for('menus') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Menus
        </a>
    </div>

    <!-- Menu Details Form -->
    {% set menu_colors = ['#f0f9ff', '#fef3c7', '#f0fdf4', '#fef2f2', '#f3f4f6', '#ede9fe', '#fdf2f8', '#ecfdf5'] %}
    {% set menu_color = menu_colors[menu.id % menu_colors|length] %}
    <div class="card mb-4 menu-details-card" style="background-color: var(--card-bg); border: 1px solid var(--border-color);">
        <div class="card-header" style="background-color: var(--card-header-bg); border-bottom: 1px solid var(--border-color);">
            <h3>Menu Details</h3>
        </div>
        <div class="card-body">
            <form method="POST">
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="menu_name">Menu Name</label>
                        <input type="text" class="form-control" id="menu_name" name="menu_name" 
                               value="{{ menu.menu_name }}" required>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="is_active">Status</label>
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="is_active" 
                                   name="is_active" {% if menu.is_active %}checked{% endif %}>
                            <label class="custom-control-label" for="is_active">Active Menu</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea class="form-control" id="description" name="description" 
                              rows="2">{{ menu.description or '' }}</textarea>
                </div>
                <button type="submit" class="btn btn-modern">
                    <i class="fas fa-save"></i> Save Details
                </button>
            </form>
        </div>
    </div>

    <!-- Menu Items Assignment -->
    <div class="card">
        <div class="card-header" style="background-color: var(--card-header-bg); border-bottom: 2px solid var(--border-color);">
            <h3>Menu Items</h3>
            <p class="mb-0 text-muted">Check items to include in this menu</p>
        </div>
        <div class="card-body" style="background-color: var(--card-bg);">
            <!-- Category Tabs -->
            <ul class="nav nav-tabs mb-3" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-toggle="tab" href="#all-items">
                        All Items
                    </a>
                </li>
                {% for category in categories %}
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#cat-{{ loop.index }}">
                        {{ category.category_name }}
                    </a>
                </li>
                {% endfor %}
            </ul>

            <!-- Tab Content -->
            <div class="tab-content">
                <div class="tab-pane fade show active" id="all-items">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" id="select-all">
                                    </th>
                                    <th>Item Name</th>
                                    <th>Category</th>
                                    <th>Base Price</th>
                                    <th>Food Cost</th>
                                    <th>Override Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in menu_items %}
                                <tr class="{% if item.is_assigned %}table-success{% endif %}">
                                    <td>
                                        <input type="checkbox" 
                                               class="item-checkbox" 
                                               data-item-id="{{ item.id }}"
                                               {% if item.is_assigned %}checked{% endif %}>
                                    </td>
                                    <td>
                                        <strong>{{ item.item_name }}</strong>
                                        {% if item.recipe_name %}
                                            <br><small class="text-muted">{{ item.recipe_name }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <select class="form-control form-control-sm category-select" 
                                                data-item-id="{{ item.id }}">
                                            <option value="">Uncategorized</option>
                                            {% for cat in categories %}
                                                <option value="{{ cat.category_name }}" 
                                                        {% if item.category == cat.category_name %}selected{% endif %}>
                                                    {{ cat.category_name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>${{ "%.2f"|format(item.menu_price or 0) }}</td>
                                    <td>
                                        {% if item.food_cost %}
                                            ${{ "%.2f"|format(item.food_cost) }} 
                                            ({{ "%.1f"|format(item.food_cost_percentage or 0) }}%)
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <input type="number" 
                                               class="form-control form-control-sm override-price" 
                                               data-item-id="{{ item.id }}"
                                               value="{{ "%.2f"|format(item.override_price) if item.override_price else '' }}"
                                               placeholder="{{ "%.2f"|format(item.menu_price or 0) }}"
                                               step="0.01">
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions -->
            <div class="mt-3">
                <button class="btn btn-success" onclick="saveSelections(event)">
                    <i class="fas fa-check"></i> Save All Changes
                </button>
                <button class="btn btn-secondary" onclick="location.reload()">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Select all checkbox
document.getElementById('select-all').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.item-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
});

// Save all selections
function saveSelections(event) {
    const changes = [];
    
    // Collect all checkbox states
    document.querySelectorAll('.item-checkbox').forEach(cb => {
        const itemId = cb.dataset.itemId;
        const isChecked = cb.checked;
        const category = document.querySelector(`.category-select[data-item-id="${itemId}"]`).value;
        const overridePrice = document.querySelector(`.override-price[data-item-id="${itemId}"]`).value;
        
        changes.push({
            item_id: itemId,
            action: isChecked ? 'add' : 'remove',
            category: category,
            override_price: overridePrice
        });
    });
    
    // Show loading state
    const saveBtn = event.currentTarget;
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    
    // Send bulk update via AJAX
    fetch('{{ url_for("bulk_update_menu_items", menu_id=menu.id) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ items: changes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to refresh the page
            window.location.href = data.redirect;
        } else {
            alert('Error saving changes: ' + (data.error || 'Unknown error'));
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    })
    .catch(error => {
        alert('Error saving changes: ' + error);
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
    });
}
</script>

<style>
/* Define missing CSS variables for compatibility */
:root {
    --card-bg: var(--surface-color, #ffffff);
    --card-header-bg: var(--surface-secondary, #f9fafb);
    --input-bg: var(--surface-color, #ffffff);
    --hover-bg: var(--surface-secondary, #f9fafb);
}

[data-theme="dark"] {
    --card-bg: var(--surface-color, #1f2937);
    --card-header-bg: var(--surface-secondary, #111827);
    --input-bg: var(--surface-color, #1f2937);
    --hover-bg: var(--surface-secondary, #111827);
}

.card {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.card-header {
    background: var(--gradient-primary);
    color: white;
    border: none;
}

.card-header h3 {
    margin: 0;
    font-size: 1.25rem;
}

/* Override for menu details card */
.menu-details-card .card-header {
    background: transparent !important;
    color: var(--text-primary) !important;
}

.menu-details-card .card-header h3 {
    color: var(--text-primary) !important;
}

/* Ensure form elements are readable */
.menu-details-card .form-control,
.menu-details-card textarea {
    background-color: var(--input-bg) !important;
    border: 1px solid var(--border-color) !important;
    color: var(--text-primary) !important;
}

.menu-details-card .form-control:focus,
.menu-details-card textarea:focus {
    border-color: #6366f1 !important;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1) !important;
}

/* Better table styling */
.table {
    background-color: var(--card-bg);
}

.table thead th {
    background-color: var(--surface-color);
    border-bottom: 2px solid var(--border-color);
    font-weight: 600;
    color: var(--text-primary);
}

.table tbody tr:hover {
    background-color: var(--hover-bg);
}

.table-success {
    background-color: rgba(16, 185, 129, 0.1) !important;
}

[data-theme="dark"] .table-success {
    background-color: rgba(16, 185, 129, 0.2) !important;
}

.table-success:hover {
    background-color: rgba(16, 185, 129, 0.15) !important;
}

[data-theme="dark"] .table-success:hover {
    background-color: rgba(16, 185, 129, 0.25) !important;
}

.nav-tabs .nav-link {
    color: var(--color-primary);
    border: none;
    border-bottom: 2px solid transparent;
}

.nav-tabs .nav-link.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
    background: none;
}


.form-control-sm {
    height: calc(1.5em + .5rem + 2px);
    padding: .25rem .5rem;
    font-size: .875rem;
}

.custom-switch {
    padding-left: 2.25rem;
    padding-top: 0.25rem;
}
</style>
{% endblock %}