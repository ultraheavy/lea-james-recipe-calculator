{% extends "base_modern.html" %}

{% block title %}Recipe CSV Staging Review{% endblock %}

{% block content %}
<style>
    .staging-container {
        padding: 20px;
        max-width: 100%;
    }
    
    .staging-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 20px;
    }
    
    .batch-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        text-align: center;
    }
    
    .stat-card h3 {
        margin: 0;
        font-size: 2em;
        color: var(--primary-color);
    }
    
    .stat-card p {
        margin: 5px 0 0;
        color: var(--text-secondary);
        font-size: 0.9em;
    }
    
    .stat-card.stat-warning {
        background: #fff3cd;
        border-color: #ffeaa7;
    }
    
    .stat-card.stat-warning h3 {
        color: #856404;
    }
    
    .stat-card.stat-success {
        background: #d4edda;
        border-color: #c3e6cb;
    }
    
    .stat-card.stat-success h3 {
        color: #155724;
    }
    
    .stat-card.stat-danger {
        background: #f8d7da;
        border-color: #f5c6cb;
    }
    
    .stat-card.stat-danger h3 {
        color: #721c24;
    }
    
    .filters-bar {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: end;
    }
    
    .filter-group {
        flex: 1;
        min-width: 200px;
    }
    
    .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 0.9em;
        color: var(--text-secondary);
    }
    
    .review-table {
        background: var(--card-bg);
        border-radius: 8px;
        overflow-x: auto !important;
        overflow-y: visible;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        -webkit-overflow-scrolling: touch;
        max-width: 100%;
    }
    
    .review-table::-webkit-scrollbar {
        height: 12px;
    }
    
    .review-table::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 6px;
    }
    
    .review-table::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 6px;
    }
    
    .review-table::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    .review-table table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .review-table th {
        background: var(--table-header-bg);
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: var(--text-primary);
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .review-table td {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .review-table tr:hover {
        background: var(--hover-bg);
    }
    
    .review-table tr.row-has-issues {
        background-color: #fff3cd !important;
    }
    
    .review-table tr.row-has-issues:hover {
        background-color: #ffe69c !important;
    }
    
    .issue-indicators {
        display: inline-block;
        position: relative;
        margin-left: 5px;
        vertical-align: middle;
    }
    
    .issue-flag {
        cursor: help;
        font-size: 1.2em;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
    }
    
    .issue-tooltip {
        position: absolute;
        left: 30px;
        top: -10px;
        background: #333;
        color: white;
        padding: 10px 15px;
        border-radius: 6px;
        font-size: 0.85em;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        z-index: 1000;
        min-width: 200px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    
    .issue-tooltip strong {
        display: block;
        margin-bottom: 5px;
        color: #ffc107;
    }
    
    .issue-tooltip ul {
        margin: 0;
        padding-left: 20px;
        list-style: disc;
    }
    
    .issue-tooltip li {
        margin: 2px 0;
    }
    
    .issue-tooltip::before {
        content: '';
        position: absolute;
        right: 100%;
        top: 20px;
        border: 6px solid transparent;
        border-right-color: #333;
    }
    
    .issue-indicators:hover .issue-tooltip {
        opacity: 1;
        pointer-events: auto;
    }
    
    .issue-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.75em;
        font-weight: 500;
        margin: 0 2px;
    }
    
    .issue-badge.missing-unit {
        background: #dc3545;
        color: white;
    }
    
    .issue-badge.zero-cost {
        background: #fd7e14;
        color: white;
    }
    
    .issue-badge.missing-quantity {
        background: #ffc107;
        color: #000;
    }
    
    .issue-badge.invalid-type {
        background: #0dcaf0;
        color: #000;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 500;
    }
    
    .status-pending {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-approved {
        background: #d4edda;
        color: #155724;
    }
    
    .status-rejected {
        background: #f8d7da;
        color: #721c24;
    }
    
    .flag-indicator {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        text-align: center;
        line-height: 20px;
        font-size: 12px;
        font-weight: bold;
        cursor: help;
        margin-left: 5px;
    }
    
    .flag-error {
        background: #dc3545;
        color: white;
    }
    
    .flag-warning {
        background: #ffc107;
        color: #212529;
    }
    
    .flag-info {
        background: #17a2b8;
        color: white;
    }
    
    .editable {
        cursor: pointer;
        position: relative;
        padding: 2px 4px;
        border-radius: 3px;
        transition: background 0.2s;
    }
    
    .editable:hover {
        background: var(--hover-bg);
    }
    
    .editable.editing {
        background: #fff;
        box-shadow: 0 0 0 2px var(--primary-color);
    }
    
    .edit-input {
        border: none;
        background: transparent;
        width: 100%;
        padding: 2px 4px;
        font: inherit;
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
    }
    
    .btn-primary {
        background: var(--primary-color);
        color: white;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn:hover {
        opacity: 0.8;
        transform: translateY(-1px);
    }
    
    .checkbox-col {
        width: 40px;
    }
    
    .row-actions {
        display: flex;
        gap: 5px;
        justify-content: center;
    }
    
    .btn-action {
        background: transparent;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.2s;
    }
    
    .btn-action:hover {
        background: var(--hover-bg);
        transform: scale(1.1);
    }
    
    .btn-approve:hover {
        border-color: #28a745;
        background: #d4edda;
    }
    
    .btn-reject:hover {
        border-color: #dc3545;
        background: #f8d7da;
    }
    
    .btn-delete:hover {
        border-color: #6c757d;
        background: #e2e3e5;
    }
    
    .select-all {
        cursor: pointer;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 30px;
    }
    
    .page-link {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        text-decoration: none;
        color: var(--text-primary);
        transition: all 0.2s;
    }
    
    .page-link:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .page-link.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .page-link.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .tooltip {
        position: absolute;
        background: #333;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 1000;
        white-space: nowrap;
        display: none;
    }
    
    .bulk-actions {
        position: sticky;
        bottom: 0;
        background: var(--card-bg);
        padding: 15px;
        border-top: 2px solid var(--border-color);
        display: none;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }
    
    .bulk-actions.show {
        display: flex;
    }
    
    .selected-count {
        font-weight: 600;
        color: var(--primary-color);
    }
    
    .table-wrapper {
        position: relative;
    }
    
    .scroll-hint {
        text-align: center;
        color: #666;
        font-size: 14px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 10px;
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .issue-summary {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .issue-summary h3 {
        margin: 0 0 15px 0;
        color: #856404;
        font-size: 1.2em;
    }
    
    .issue-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }
    
    .issue-summary-item {
        background: white;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
        border: 1px solid #ffeaa7;
    }
    
    .issue-count {
        display: block;
        font-size: 2em;
        font-weight: bold;
        color: #856404;
        margin-bottom: 5px;
    }
    
    .issue-label {
        display: block;
        font-size: 0.9em;
        color: #666;
    }
    
    .checkbox-col {
        width: 80px;
        position: relative;
    }
    
    .checkbox-col input[type="checkbox"] {
        margin-right: 5px;
    }
    
    .approval-cell {
        text-align: center;
    }
    
    .approval-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .approval-checkbox:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }
    
    .edit-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        overflow-y: auto;
    }
    
    .edit-modal-content {
        background: white;
        margin: 50px auto;
        padding: 30px;
        width: 90%;
        max-width: 600px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    
    .edit-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .edit-modal-header h2 {
        margin: 0;
        color: var(--primary-color);
    }
    
    .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6c757d;
    }
    
    .close-modal:hover {
        color: #000;
    }
    
    .edit-form-group {
        margin-bottom: 15px;
    }
    
    .edit-form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #495057;
    }
    
    .edit-form-group input,
    .edit-form-group select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .edit-form-group input:focus,
    .edit-form-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(0,123,255,0.1);
    }
    
    .edit-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #e9ecef;
    }
    
    .btn-edit-action {
        padding: 8px 20px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .btn-save {
        background: var(--primary-color);
        color: white;
    }
    
    .btn-save:hover {
        background: #0056b3;
    }
    
    .btn-cancel {
        background: #6c757d;
        color: white;
    }
    
    .btn-cancel:hover {
        background: #545b62;
    }
    
    .source-info {
        display: inline-block;
        margin-left: 5px;
        color: #6c757d;
        font-size: 0.8em;
        cursor: help;
        position: relative;
    }
    
    .source-info-icon {
        display: inline-block;
        width: 16px;
        height: 16px;
        background: #6c757d;
        color: white;
        border-radius: 50%;
        text-align: center;
        line-height: 16px;
        font-size: 10px;
        font-weight: bold;
    }
    
    .source-tooltip {
        position: absolute;
        left: 20px;
        top: -5px;
        background: #333;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 0.85em;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .source-tooltip::before {
        content: '';
        position: absolute;
        right: 100%;
        top: 50%;
        transform: translateY(-50%);
        border: 5px solid transparent;
        border-right-color: #333;
    }
    
    .source-info:hover .source-tooltip {
        opacity: 1;
    }
    
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }
    
    .toast {
        background: white;
        border-radius: 8px;
        padding: 16px 24px;
        margin-bottom: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 300px;
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .toast.success {
        border-left: 4px solid #28a745;
    }
    
    .toast.error {
        border-left: 4px solid #dc3545;
    }
    
    .toast.info {
        border-left: 4px solid #17a2b8;
    }
    
    .toast-icon {
        font-size: 24px;
    }
    
    .toast.success .toast-icon {
        color: #28a745;
    }
    
    .toast.error .toast-icon {
        color: #dc3545;
    }
    
    .toast.info .toast-icon {
        color: #17a2b8;
    }
    
    .toast-content h4 {
        margin: 0 0 4px 0;
        font-size: 16px;
        font-weight: 600;
    }
    
    .toast-content p {
        margin: 0;
        font-size: 14px;
        color: #666;
    }
    
    .toast-close {
        margin-left: auto;
        background: none;
        border: none;
        font-size: 20px;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .toast-close:hover {
        color: #333;
    }

    /* Recipe-specific styles */
    .recipe-type-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 500;
        margin-left: 5px;
    }
    
    .recipe-type-food {
        background: #e3f2fd;
        color: #1565c0;
    }
    
    .recipe-type-beverage {
        background: #f3e5f5;
        color: #6a1b9a;
    }
    
    .recipe-type-prep {
        background: #e8f5e9;
        color: #2e7d32;
    }
    
    .category-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.75em;
        background: #f0f0f0;
        color: #333;
        margin-left: 5px;
    }
</style>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<div class="staging-container">
    <div class="staging-header">
        <h1>Recipe CSV Staging Review</h1>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-info" onclick="refreshData()" title="Clear and reload all data from CSV files">
                🔄 Reload from CSV
            </button>
            <button class="btn btn-primary" onclick="bulkApproveValid()">
                ✅ Bulk Approve Valid Rows
            </button>
            <button class="btn btn-success" onclick="processToLive()">
                📤 Process to Live
            </button>
        </div>
    </div>
    
    <!-- Batch Statistics -->
    <div class="batch-stats" id="batchStats">
        <div class="stat-card">
            <h3 id="totalRecipes">{{ stats.recipes.total }}</h3>
            <p>Total Recipes</p>
        </div>
        <div class="stat-card" style="background: #e8d4ff; border-color: #d4b5ff;">
            <h3 id="prepRecipes" style="color: #6f42c1;">{{ stats.recipes.prep }}</h3>
            <p>Prep Recipes</p>
        </div>
        <div class="stat-card stat-success">
            <h3 id="approvedCount">{{ stats.overall.approved }}</h3>
            <p>Approved Items</p>
        </div>
        <div class="stat-card stat-danger">
            <h3 id="needsReviewCount">{{ stats.overall.needs_review }}</h3>
            <p>Needs Review</p>
        </div>
    </div>
    
    <!-- Issue Summary -->
    {% set missing_unit_count = 0 %}
    {% set zero_cost_count = 0 %}
    {% set missing_quantity_count = 0 %}
    {% set invalid_type_count = 0 %}
    {% for item in items %}
        {% if not item.unit or item.unit == '-' %}
            {% set missing_unit_count = missing_unit_count + 1 %}
        {% endif %}
        {% if not item.cost or item.cost == 0 %}
            {% set zero_cost_count = zero_cost_count + 1 %}
        {% endif %}
        {% if not item.quantity or item.quantity == 0 %}
            {% set missing_quantity_count = missing_quantity_count + 1 %}
        {% endif %}
        {% if item.recipe_type and item.recipe_type not in ['food', 'beverage', 'prep'] %}
            {% set invalid_type_count = invalid_type_count + 1 %}
        {% endif %}
    {% endfor %}
    
    {% if missing_unit_count > 0 or zero_cost_count > 0 or missing_quantity_count > 0 or invalid_type_count > 0 %}
    <div class="issue-summary">
        <h3>⚠️ Issues Found</h3>
        <div class="issue-summary-grid">
            {% if missing_unit_count > 0 %}
            <div class="issue-summary-item">
                <span class="issue-count">{{ missing_unit_count }}</span>
                <span class="issue-label">Missing Unit</span>
            </div>
            {% endif %}
            {% if zero_cost_count > 0 %}
            <div class="issue-summary-item">
                <span class="issue-count">{{ zero_cost_count }}</span>
                <span class="issue-label">Zero/Missing Cost</span>
            </div>
            {% endif %}
            {% if missing_quantity_count > 0 %}
            <div class="issue-summary-item">
                <span class="issue-count">{{ missing_quantity_count }}</span>
                <span class="issue-label">Missing Quantity</span>
            </div>
            {% endif %}
            {% if invalid_type_count > 0 %}
            <div class="issue-summary-item">
                <span class="issue-count">{{ invalid_type_count }}</span>
                <span class="issue-label">Invalid Type</span>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <!-- Filters -->
    <div class="filters-bar">
        <div class="filter-group">
            <label>Batch</label>
            <select id="batchFilter" onchange="applyFilters()">
                <option value="">All Batches</option>
                {% for batch in batches %}
                <option value="{{ batch.batch_id }}" {% if filters.batch_id == batch.batch_id %}selected{% endif %}>
                    {{ batch.batch_id }} ({{ batch.total_rows }} items)
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-group">
            <label>Review Status</label>
            <select id="statusFilter" onchange="applyFilters()">
                <option value="">All Statuses</option>
                <option value="pending" {% if filters.review_status == 'pending' %}selected{% endif %}>Pending</option>
                <option value="approved" {% if filters.review_status == 'approved' %}selected{% endif %}>Approved</option>
                <option value="rejected" {% if filters.review_status == 'rejected' %}selected{% endif %}>Rejected</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Recipe Type</label>
            <select id="typeFilter" onchange="applyFilters()">
                <option value="">All Types</option>
                <option value="food" {% if filters.recipe_type == 'food' %}selected{% endif %}>Food</option>
                <option value="beverage" {% if filters.recipe_type == 'beverage' %}selected{% endif %}>Beverage</option>
                <option value="prep" {% if filters.recipe_type == 'prep' %}selected{% endif %}>Prep</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Has Issues</label>
            <select id="issuesFilter" onchange="applyFilters()">
                <option value="">All</option>
                <option value="1" {% if filters.has_issues == 1 %}selected{% endif %}>With Issues</option>
                <option value="0" {% if filters.has_issues == 0 %}selected{% endif %}>No Issues</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Search</label>
            <input type="text" id="searchFilter" placeholder="Search recipes or ingredients..." 
                   value="{{ filters.search or '' }}" onkeyup="debounceSearch()">
        </div>
        
        <div class="filter-group">
            <label>Items per page</label>
            <select id="perPageFilter" onchange="applyFilters()">
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
                <option value="all" {% if per_page == 'all' or per_page > 1000 %}selected{% endif %}>All</option>
            </select>
        </div>
        
        <div class="filter-group">
            <button class="btn btn-primary" onclick="clearFilters()">Clear Filters</button>
        </div>
    </div>
    
    <!-- Review Table -->
    <div class="table-wrapper">
        <div class="scroll-hint">← Scroll horizontally to see all columns →</div>
        <div class="review-table">
        <table>
            <thead>
                <tr>
                    <th class="checkbox-col">
                        <input type="checkbox" class="select-all" onchange="toggleSelectAll(this)">
                    </th>
                    <th>Approved</th>
                    <th>Recipe Name</th>
                    <th>Ingredient</th>
                    <th>Quantity</th>
                    <th>Unit</th>
                    <th>Cost</th>
                    <th>Category</th>
                    <th>Type</th>
                    <th>Source</th>
                    <th>Status</th>
                    <th>Issues</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                {% set issues = [] %}
                {% set has_issues = false %}
                
                {# Check for missing unit #}
                {% if not item.unit or item.unit == '-' %}
                    {% set _ = issues.append({'type': 'missing_unit', 'message': 'Missing unit of measure'}) %}
                    {% set has_issues = true %}
                {% endif %}
                
                {# Check for zero or missing cost #}
                {% if not item.cost or item.cost == 0 %}
                    {% set _ = issues.append({'type': 'zero_cost', 'message': 'Cost is $0 or missing'}) %}
                    {% set has_issues = true %}
                {% endif %}
                
                {# Check for missing quantity #}
                {% if not item.quantity or item.quantity == 0 %}
                    {% set _ = issues.append({'type': 'missing_quantity', 'message': 'Quantity is 0 or missing'}) %}
                    {% set has_issues = true %}
                {% endif %}
                
                {# Check for invalid recipe type #}
                {% if item.recipe_type and item.recipe_type not in ['food', 'beverage', 'prep'] %}
                    {% set _ = issues.append({'type': 'invalid_type', 'message': 'Invalid recipe type'}) %}
                    {% set has_issues = true %}
                {% endif %}
                
                <tr data-id="{{ item.staging_id }}" class="{% if has_issues %}row-has-issues{% endif %} {% if item.needs_review %}needs-review{% endif %}" data-issues="{{ issues|tojson|e }}">
                    <td>
                        <input type="checkbox" class="item-select" value="{{ item.staging_id }}">
                        {% if has_issues %}
                        <div class="issue-indicators">
                            <span class="issue-flag" title="This row has {{ issues|length }} issue(s)">⚠️</span>
                            <div class="issue-tooltip">
                                <strong>Issues found:</strong>
                                <ul>
                                {% for issue in issues %}
                                    <li>{{ issue.message }}</li>
                                {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% endif %}
                        <div class="source-info">
                            <span class="source-info-icon" title="Source info">ℹ</span>
                            <div class="source-tooltip">
                                {% if item.source_filename %}File: {{ item.source_filename }}{% endif %}
                                {% if item.original_row_number %} • Row: {{ item.original_row_number }}{% endif %}
                            </div>
                        </div>
                    </td>
                    <td class="approval-cell">
                        <input type="checkbox" 
                               class="approval-checkbox" 
                               data-id="{{ item.staging_id }}"
                               {% if item.review_status == 'approved' %}checked{% endif %}
                               {% if has_issues %}disabled title="Cannot approve items with validation issues"{% endif %}
                               onchange="toggleApproval({{ item.staging_id }}, this)">
                    </td>
                    <td>
                        <div class="editable" data-field="recipe_name">
                            {{ item.recipe_name or '' }}
                            {% if item.recipe_name_flag %}
                                <span class="flag-indicator flag-warning" title="{{ item.recipe_name_flag }}">!</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="editable" data-field="ingredient_name">
                            {{ item.ingredient_name or '' }}
                            {% if item.ingredient_flag %}
                                <span class="flag-indicator flag-warning" title="{{ item.ingredient_flag }}">!</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="editable" data-field="quantity">
                            {{ item.quantity or 0 }}
                            {% if item.quantity_flag %}
                                <span class="flag-indicator flag-info" title="{{ item.quantity_flag }}">!</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="editable" data-field="unit">
                            {{ item.unit or '-' }}
                            {% if item.unit_flag %}
                                <span class="flag-indicator flag-warning" title="{{ item.unit_flag }}">!</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="editable" data-field="cost">
                            ${{ "%.2f"|format(item.cost|float if item.cost else 0) }}
                            {% if item.cost_flag %}
                                <span class="flag-indicator flag-warning" title="{{ item.cost_flag }}">!</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {{ item.category or '' }}
                        {% if item.category %}
                            <span class="category-badge">{{ item.category }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.is_prep_recipe %}
                            <span class="recipe-type-badge" style="background-color: #6f42c1; color: white;">
                                Prep Recipe
                            </span>
                        {% else %}
                            <span class="recipe-type-badge" style="background-color: #28a745; color: white;">
                                Recipe
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.used_as_ingredient %}
                            <span class="source-badge" style="background-color: #17a2b8; color: white;" 
                                  title="Used as ingredient in other recipes">
                                {{ item.ingredient_source_type|title }}
                            </span>
                            {% if item.has_prep_dependencies %}
                                <span class="flag-indicator flag-error" 
                                      title="Missing prep recipe: {{ item.missing_prep_recipes }}">!</span>
                            {% endif %}
                        {% else %}
                            <span class="source-badge" style="background-color: #6c757d; color: white;">
                                Inventory
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-badge status-{{ item.review_status or 'pending' }}">
                            {{ item.review_status or 'pending' }}
                        </span>
                    </td>
                    <td>
                        {% if item.needs_review %}
                            <div class="flags-detail" title="{{ item.review_notes }}">
                                <span class="flag-indicator flag-error">!</span>
                                <small>{{ (item.review_notes or '')[:50] }}...</small>
                            </div>
                        {% else %}
                            <span style="color: #28a745;">✓</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="row-actions">
                            <button class="btn-action btn-edit" onclick="editItem({{ item.staging_id }})" title="Edit">
                                <span style="color: #007bff;">✏️</span>
                            </button>
                            <button class="btn-action btn-delete" onclick="deleteItem({{ item.staging_id }})" title="Delete">
                                <span style="color: #dc3545;">🗑</span>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    </div>
    
    <!-- Pagination -->
    {% if per_page != 'all' and total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
            <a href="?page={{ page - 1 }}&{{ request.query_string.decode() }}" class="page-link">Previous</a>
        {% else %}
            <span class="page-link disabled">Previous</span>
        {% endif %}
        
        <span>Page {{ page }} of {{ total_pages }}</span>
        
        {% if page < total_pages %}
            <a href="?page={{ page + 1 }}&{{ request.query_string.decode() }}" class="page-link">Next</a>
        {% else %}
            <span class="page-link disabled">Next</span>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Bulk Actions Bar -->
    <div class="bulk-actions" id="bulkActions">
        <div>
            <span class="selected-count">0</span> items selected
        </div>
        <div>
            <button class="btn btn-success" onclick="bulkAction('approve')">Approve Selected</button>
            <button class="btn btn-danger" onclick="bulkAction('reject')">Reject Selected</button>
        </div>
    </div>
</div>

<script>
// Global variables
let selectedItems = new Set();
let searchTimeout;

// Toggle select all
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.item-select');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        if (checkbox.checked) {
            selectedItems.add(cb.value);
        } else {
            selectedItems.delete(cb.value);
        }
    });
    updateBulkActions();
}

// Handle individual checkbox changes
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('item-select')) {
        if (e.target.checked) {
            selectedItems.add(e.target.value);
        } else {
            selectedItems.delete(e.target.value);
        }
        updateBulkActions();
    }
});

// Update bulk actions bar
function updateBulkActions() {
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.querySelector('.selected-count');
    
    if (selectedItems.size > 0) {
        bulkActions.classList.add('show');
        selectedCount.textContent = selectedItems.size;
    } else {
        bulkActions.classList.remove('show');
    }
}

// Apply filters
function applyFilters() {
    const params = new URLSearchParams();
    
    const batch = document.getElementById('batchFilter').value;
    if (batch) params.append('batch_id', batch);
    
    const status = document.getElementById('statusFilter').value;
    if (status) params.append('review_status', status);
    
    const type = document.getElementById('typeFilter').value;
    if (type) params.append('recipe_type', type);
    
    const issues = document.getElementById('issuesFilter').value;
    if (issues !== '') params.append('has_issues', issues);
    
    const search = document.getElementById('searchFilter').value;
    if (search) params.append('search', search);
    
    const perPage = document.getElementById('perPageFilter').value;
    if (perPage && perPage !== '50') params.append('per_page', perPage);
    
    window.location.href = '?' + params.toString();
}

// Debounce search
function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(applyFilters, 500);
}

// Clear filters
function clearFilters() {
    window.location.href = window.location.pathname;
}

// Inline editing
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('editable') && !e.target.classList.contains('editing')) {
        const field = e.target.dataset.field;
        const currentValue = e.target.textContent.trim();
        const row = e.target.closest('tr');
        const itemId = row.dataset.id;
        
        // Remove any flag indicators and currency symbols from the value
        let cleanValue = currentValue.replace(/!$/, '').trim();
        if (field === 'cost') {
            cleanValue = cleanValue.replace('$', '');
        }
        
        e.target.classList.add('editing');
        const inputType = (field === 'quantity' || field === 'cost') ? 'number' : 'text';
        const step = field === 'cost' ? '0.01' : '1';
        e.target.innerHTML = `<input type="${inputType}" class="edit-input" value="${cleanValue}" data-field="${field}" data-id="${itemId}" step="${step}">`;
        
        const input = e.target.querySelector('.edit-input');
        input.focus();
        input.select();
        
        input.addEventListener('blur', saveEdit);
        input.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                saveEdit.call(this);
            }
        });
    }
});

// Save inline edit
function saveEdit() {
    const field = this.dataset.field;
    const itemId = this.dataset.id;
    const newValue = this.value;
    const parent = this.parentElement;
    
    // Send update to server
    fetch(`/admin/recipe-csv-staging/item/${itemId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            [field]: newValue
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            parent.classList.remove('editing');
            if (field === 'cost') {
                parent.textContent = `$${parseFloat(newValue).toFixed(2)}`;
            } else {
                parent.textContent = newValue;
            }
            showToast('success', 'Updated', 'Field updated successfully');
        } else {
            showToast('error', 'Update Failed', data.message || 'Failed to update item');
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Error', 'Failed to update item');
        location.reload();
    });
}

// Bulk actions
function bulkAction(action) {
    if (selectedItems.size === 0) return;
    
    const message = action === 'approve' 
        ? `Approve ${selectedItems.size} items?` 
        : `Reject ${selectedItems.size} items?`;
    
    if (!confirm(message)) return;
    
    fetch('/admin/recipe-csv-staging/batch-action', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            staging_ids: Array.from(selectedItems),
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success > 0) {
            showToast('success', 'Success', `Successfully ${action}d ${data.success} items`);
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('error', 'Failed', 'Failed to update items');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Error', 'Failed to update items');
    });
}

// Individual row actions
function deleteItem(itemId) {
    if (confirm('Are you sure you want to delete this item?')) {
        fetch('/admin/recipe-csv-staging/batch-action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                staging_ids: [itemId.toString()],
                action: 'delete'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success > 0) {
                showToast('success', 'Deleted', 'Item deleted successfully');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('error', 'Failed', 'Failed to delete item');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('error', 'Error', 'Failed to delete item');
        });
    }
}

// Refresh data from CSV files
function refreshData() {
    if (!confirm('This will clear all staging data and reload from CSV files. Continue?')) {
        return;
    }
    
    showToast('info', 'Refreshing', 'Reloading data from CSV files...');
    
    fetch('/admin/recipe-csv-staging/refresh-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', 'Success', data.message);
            // Reload page after a short delay
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showToast('error', 'Error', data.message || 'Failed to refresh data');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Error', 'Failed to refresh data');
    });
}

// Bulk approve all valid rows
function bulkApproveValid() {
    // Find all rows that don't have issues
    const validRows = document.querySelectorAll('tr:not(.row-has-issues)');
    const validIds = [];
    
    validRows.forEach(row => {
        const checkbox = row.querySelector('.item-select');
        if (checkbox && row.dataset.id) {
            // Check if not already approved
            const statusBadge = row.querySelector('.status-badge');
            if (statusBadge && !statusBadge.classList.contains('status-approved')) {
                validIds.push(row.dataset.id);
            }
        }
    });
    
    if (validIds.length === 0) {
        showToast('info', 'No Valid Rows', 'No valid rows to approve');
        return;
    }
    
    if (!confirm(`Approve ${validIds.length} valid rows?`)) return;
    
    fetch('/admin/recipe-csv-staging/batch-action', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            staging_ids: validIds,
            action: 'approve'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success > 0) {
            showToast('success', 'Success', `Successfully approved ${data.success} items`);
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('error', 'Failed', 'Failed to approve items');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Error', 'Failed to approve items');
    });
}

// Process to live
function processToLive() {
    // First, get count of approved items without validation issues
    const approvedValidRows = document.querySelectorAll('tr[data-id]').length > 0 ? 
        Array.from(document.querySelectorAll('tr[data-id]')).filter(row => {
            const checkbox = row.querySelector('.approval-checkbox');
            const hasIssues = row.classList.contains('row-has-issues');
            return checkbox && checkbox.checked && !hasIssues;
        }).length : 0;
    
    if (approvedValidRows === 0) {
        showToast('info', 'No Records to Process', 'There are no approved records without validation issues to process.');
        return;
    }
    
    const batch = document.getElementById('batchFilter').value;
    const message = batch 
        ? `Process ${approvedValidRows} approved recipe ingredients from this batch to live database?` 
        : `Process ${approvedValidRows} approved recipe ingredients to live database?`;
    
    if (!confirm(message)) return;
    
    // Show processing toast
    showToast('info', 'Processing', 'Processing approved records to live database...');
    
    fetch('/admin/recipe-csv-staging/process-to-live', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            batch_id: batch || null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.processed > 0) {
            showToast('success', 'Success', 
                `${data.processed} recipe ingredients have been processed to the live database.${data.errors > 0 ? ` ${data.errors} records had errors.` : ''}`);
            
            // Reload after a short delay
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showToast('error', 'No Records Processed', 
                `No records were processed. ${data.errors > 0 ? `${data.errors} records had errors.` : 'Please check the records and try again.'}`);
        }
        
        if (data.details && data.details.length > 0) {
            console.log('Processing details:', data.details);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Processing Failed', 'Failed to process records. Please try again.');
    });
}

// Toast notification system
function showToast(type, title, message) {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const icons = {
        success: '✓',
        error: '✗',
        info: 'ℹ'
    };
    
    toast.innerHTML = `
        <span class="toast-icon">${icons[type]}</span>
        <div class="toast-content">
            <h4>${title}</h4>
            <p>${message}</p>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">×</button>
    `;
    
    toastContainer.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// Update statistics counts
function updateStatistics() {
    const rows = document.querySelectorAll('tbody tr');
    let total = 0;
    let approved = 0;
    let pending = 0;
    let needsReview = 0;
    
    rows.forEach(row => {
        if (row.style.display === 'none') return;
        
        total++;
        
        const checkbox = row.querySelector('.approval-checkbox');
        const hasIssues = row.classList.contains('row-has-issues');
        const statusBadge = row.querySelector('.status-badge');
        
        if (checkbox && checkbox.checked) {
            approved++;
        } else if (statusBadge && statusBadge.classList.contains('status-pending')) {
            pending++;
        }
        
        if (hasIssues || row.classList.contains('needs-review')) {
            needsReview++;
        }
    });
    
    // Update the display
    document.getElementById('totalCount').textContent = total;
    document.getElementById('approvedCount').textContent = approved;
    document.getElementById('pendingCount').textContent = pending;
    document.getElementById('needsReviewCount').textContent = needsReview;
}

// Toggle approval checkbox
function toggleApproval(itemId, checkbox) {
    const isApproved = checkbox.checked;
    const action = isApproved ? 'approve' : 'pending';
    
    fetch(`/admin/recipe-csv-staging/item/${itemId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            review_status: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the status badge
            const row = document.querySelector(`tr[data-id="${itemId}"]`);
            const statusBadge = row.querySelector('.status-badge');
            if (statusBadge) {
                statusBadge.className = `status-badge status-${action}`;
                statusBadge.textContent = action;
            }
            // Update statistics
            updateStatistics();
        } else {
            // Revert checkbox on failure
            checkbox.checked = !isApproved;
            showToast('error', 'Failed', 'Failed to update approval status');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        checkbox.checked = !isApproved;
        showToast('error', 'Error', 'Failed to update approval status');
    });
}

// Edit modal functions
function editItem(itemId) {
    // TODO: Implement edit modal for recipe items
    showToast('info', 'Coming Soon', 'Edit functionality will be available soon');
}

// Add keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + A to select all visible
    if ((e.ctrlKey || e.metaKey) && e.key === 'a' && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        document.querySelector('.select-all').click();
    }
    
    // Delete key to reject selected
    if (e.key === 'Delete' && selectedItems.size > 0 && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        bulkAction('reject');
    }
});

// Initialize statistics on page load
document.addEventListener('DOMContentLoaded', function() {
    updateStatistics();
});
</script>

{% endblock %}