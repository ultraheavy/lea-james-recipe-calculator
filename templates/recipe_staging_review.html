{% extends "base_modern.html" %}

{% block title %}Recipe Staging Review{% endblock %}

{% block content %}
<style>
    .staging-container {
        padding: 20px;
        max-width: 100%;
    }
    
    .staging-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 20px;
    }
    
    .batch-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        text-align: center;
    }
    
    .stat-card h3 {
        margin: 0;
        font-size: 2em;
        color: var(--primary-color);
    }
    
    .stat-card p {
        margin: 5px 0 0;
        color: var(--text-secondary);
        font-size: 0.9em;
    }
    
    .stat-card.stat-warning {
        background: #fff3cd;
        border-color: #ffeaa7;
    }
    
    .stat-card.stat-warning h3 {
        color: #856404;
    }
    
    .stat-card.stat-success {
        background: #d4edda;
        border-color: #c3e6cb;
    }
    
    .stat-card.stat-success h3 {
        color: #155724;
    }
    
    .stat-card.stat-danger {
        background: #f8d7da;
        border-color: #f5c6cb;
    }
    
    .stat-card.stat-danger h3 {
        color: #721c24;
    }
    
    .filters-bar {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: end;
    }
    
    .filter-group {
        flex: 1;
        min-width: 200px;
    }
    
    .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 0.9em;
        color: var(--text-secondary);
    }
    
    .review-table {
        background: var(--card-bg);
        border-radius: 8px;
        overflow-x: auto !important;
        overflow-y: visible;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        -webkit-overflow-scrolling: touch;
        max-width: 100%;
    }
    
    /* Make scrollbar more visible */
    .review-table::-webkit-scrollbar {
        height: 12px;
    }
    
    .review-table::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 6px;
    }
    
    .review-table::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 6px;
    }
    
    .review-table::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    .review-table table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .review-table th {
        background: var(--table-header-bg);
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: var(--text-primary);
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .review-table td {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .review-table tr:hover {
        background: var(--hover-bg);
    }
    
    /* Highlighting for problematic rows */
    .review-table tr.row-has-warnings {
        background-color: #fff3cd !important;
    }
    
    .review-table tr.row-has-warnings:hover {
        background-color: #ffe69c !important;
    }
    
    .review-table tr.row-has-errors {
        background-color: #f8d7da !important;
    }
    
    .review-table tr.row-has-errors:hover {
        background-color: #f5c2c7 !important;
    }
    
    /* Validation Notes Styles */
    .validation-notes-cell {
        max-width: 300px;
    }
    
    .validation-notes {
        display: flex;
        align-items: flex-start;
        gap: 8px;
    }
    
    .validation-icon {
        font-size: 1.2em;
        cursor: help;
        flex-shrink: 0;
    }
    
    .error-icon {
        animation: pulse 2s infinite;
    }
    
    .warning-icon {
        animation: pulse 3s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
    }
    
    .validation-details {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        align-items: center;
    }
    
    .validation-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75em;
        font-weight: 500;
        white-space: nowrap;
    }
    
    .validation-badge.error-badge {
        background: #dc3545;
        color: white;
    }
    
    .validation-badge.warning-badge {
        background: #ffc107;
        color: #000;
    }
    
    .validation-ok {
        color: #28a745;
        font-size: 0.9em;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 500;
    }
    
    .status-pending {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-approved {
        background: #d4edda;
        color: #155724;
    }
    
    .status-rejected {
        background: #f8d7da;
        color: #721c24;
    }
    
    .status-hold {
        background: #e2e3e5;
        color: #383d41;
    }
    
    .flag-indicator {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        text-align: center;
        line-height: 20px;
        font-size: 12px;
        font-weight: bold;
        cursor: help;
        margin-left: 5px;
    }
    
    .flag-error {
        background: #dc3545;
        color: white;
    }
    
    .flag-warning {
        background: #ffc107;
        color: #212529;
    }
    
    .flag-info {
        background: #17a2b8;
        color: white;
    }
    
    .editable {
        cursor: pointer;
        position: relative;
        padding: 2px 4px;
        border-radius: 3px;
        transition: background 0.2s;
    }
    
    .editable:hover {
        background: var(--hover-bg);
    }
    
    .editable.editing {
        background: #fff;
        box-shadow: 0 0 0 2px var(--primary-color);
    }
    
    .edit-input {
        border: none;
        background: transparent;
        width: 100%;
        padding: 2px 4px;
        font: inherit;
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
    }
    
    .btn-primary {
        background: var(--primary-color);
        color: white;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn:hover {
        opacity: 0.8;
        transform: translateY(-1px);
    }
    
    .checkbox-col {
        width: 40px;
    }
    
    .row-actions {
        display: flex;
        gap: 5px;
        justify-content: center;
    }
    
    .btn-action {
        background: transparent;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.2s;
    }
    
    .btn-action:hover {
        background: var(--hover-bg);
        transform: scale(1.1);
    }
    
    .btn-approve:hover {
        border-color: #28a745;
        background: #d4edda;
    }
    
    .btn-reject:hover {
        border-color: #dc3545;
        background: #f8d7da;
    }
    
    .btn-delete:hover {
        border-color: #6c757d;
        background: #e2e3e5;
    }
    
    .select-all {
        cursor: pointer;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 30px;
    }
    
    .page-link {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        text-decoration: none;
        color: var(--text-primary);
        transition: all 0.2s;
    }
    
    .page-link:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .page-link.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .page-link.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .tooltip {
        position: absolute;
        background: #333;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 1000;
        white-space: nowrap;
        display: none;
    }
    
    .bulk-actions {
        position: sticky;
        bottom: 0;
        background: var(--card-bg);
        padding: 15px;
        border-top: 2px solid var(--border-color);
        display: none;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }
    
    .bulk-actions.show {
        display: flex;
    }
    
    .selected-count {
        font-weight: 600;
        color: var(--primary-color);
    }
    
    .flags-detail {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .flags-detail:hover {
        overflow: visible;
        white-space: normal;
        background: var(--card-bg);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 8px;
        border-radius: 4px;
        position: absolute;
        z-index: 100;
        max-width: 500px;
    }
    
    .table-wrapper {
        position: relative;
    }
    
    .scroll-hint {
        text-align: center;
        color: #666;
        font-size: 14px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 10px;
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    /* Source info styles */
    .checkbox-cell {
        text-align: center;
        position: relative;
    }
    
    .source-info {
        display: inline-block;
        position: relative;
        margin-right: 10px;
    }
    
    .source-info-icon {
        display: inline-block;
        width: 16px;
        height: 16px;
        line-height: 16px;
        border-radius: 50%;
        background: #6c757d;
        color: white;
        font-size: 11px;
        text-align: center;
        cursor: help;
    }
    
    .source-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 11px;
        white-space: nowrap;
        display: none;
        z-index: 1000;
        margin-bottom: 5px;
    }
    
    .source-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border-width: 5px;
        border-style: solid;
        border-color: #333 transparent transparent transparent;
    }
    
    .source-info:hover .source-tooltip {
        display: block;
    }
    
    .expand-details {
        cursor: pointer;
        color: var(--primary-color);
        font-size: 12px;
        text-decoration: underline;
    }
    
    .expandable-row {
        background: #f8f9fa;
    }
    
    .details-cell {
        padding: 0 !important;
    }
    
    .details-content {
        padding: 20px;
    }
    
    .details-section {
        margin-bottom: 20px;
    }
    
    .details-section:last-child {
        margin-bottom: 0;
    }
    
    .details-section h4 {
        margin: 0 0 10px 0;
        color: var(--text-primary);
        font-size: 14px;
        font-weight: 600;
    }
    
    .details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .detail-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .detail-item label {
        font-weight: 500;
        color: var(--text-secondary);
        font-size: 12px;
    }
    
    .detail-item span {
        color: var(--text-primary);
        font-size: 13px;
    }
    
    .validation-list {
        margin: 0;
        padding-left: 20px;
    }
    
    .validation-list li {
        margin-bottom: 5px;
        color: var(--text-primary);
        font-size: 13px;
    }
    
    /* Column Mapping Panel Styles */
    .column-mapping-panel {
        background: var(--card-bg);
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }
    
    .column-mapping-panel h3 {
        margin: 0 0 5px 0;
        color: var(--primary-color);
        font-size: 1.2em;
    }
    
    .mapping-subtitle {
        color: var(--text-secondary);
        font-size: 0.9em;
        margin: 0 0 20px 0;
    }
    
    .mapping-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
    }
    
    .mapping-item {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #f8f9fa;
        padding: 10px 15px;
        border-radius: 6px;
        font-size: 0.9em;
    }
    
    .original-column {
        font-weight: 600;
        color: #495057;
        flex: 1;
    }
    
    .arrow {
        color: var(--primary-color);
        font-weight: bold;
    }
    
    .mapped-column {
        font-weight: 600;
        color: var(--primary-color);
        flex: 1;
        text-align: right;
    }
    
    /* Tooltip styles for column headers */
    .column-tooltip {
        position: relative;
        cursor: help;
    }
    
    .column-tooltip::after {
        content: attr(data-original);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.85em;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        margin-bottom: 5px;
    }
    
    .column-tooltip::before {
        content: '';
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: #333;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
    }
    
    .column-tooltip:hover::after,
    .column-tooltip:hover::before {
        opacity: 1;
    }
    
    /* Issue Summary Styles */
    .issue-summary {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .issue-summary h3 {
        margin: 0 0 15px 0;
        color: #856404;
        font-size: 1.2em;
    }
    
    .issue-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }
    
    .issue-summary-item {
        background: white;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
        border: 1px solid #ffeaa7;
    }
    
    .issue-summary-item.error-item {
        background: #f8d7da;
        border-color: #f5c2c7;
    }
    
    .issue-summary-item.error-item .issue-count {
        color: #721c24;
    }
    
    .issue-count {
        display: block;
        font-size: 2em;
        font-weight: bold;
        color: #856404;
        margin-bottom: 5px;
    }
    
    .issue-label {
        display: block;
        font-size: 0.9em;
        color: #666;
    }
    
    /* Approval checkbox styles */
    .approval-cell {
        text-align: center;
    }
    
    .approval-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .approval-checkbox:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }
    
    /* Edit modal styles */
    .edit-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        overflow-y: auto;
    }
    
    .edit-modal-content {
        background: white;
        margin: 50px auto;
        padding: 30px;
        width: 90%;
        max-width: 600px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    
    .edit-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .edit-modal-header h2 {
        margin: 0;
        color: var(--primary-color);
    }
    
    .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6c757d;
    }
    
    .close-modal:hover {
        color: #000;
    }
    
    .edit-form-group {
        margin-bottom: 15px;
    }
    
    .edit-form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #495057;
    }
    
    .edit-form-group input,
    .edit-form-group select,
    .edit-form-group textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .edit-form-group input:focus,
    .edit-form-group select:focus,
    .edit-form-group textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(0,123,255,0.1);
    }
    
    .edit-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #e9ecef;
    }
    
    .btn-edit-action {
        padding: 8px 20px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .btn-save {
        background: var(--primary-color);
        color: white;
    }
    
    .btn-save:hover {
        background: #0056b3;
    }
    
    .btn-cancel {
        background: #6c757d;
        color: white;
    }
    
    .btn-cancel:hover {
        background: #545b62;
    }
    
    /* Source info styles */
    .source-info {
        display: inline-block;
        margin-left: 5px;
        color: #6c757d;
        font-size: 0.8em;
        cursor: help;
        position: relative;
    }
    
    .source-info-icon {
        display: inline-block;
        width: 16px;
        height: 16px;
        background: #6c757d;
        color: white;
        border-radius: 50%;
        text-align: center;
        line-height: 16px;
        font-size: 10px;
        font-weight: bold;
    }
    
    .source-tooltip {
        position: absolute;
        left: 20px;
        top: -5px;
        background: #333;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 0.85em;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .source-tooltip::before {
        content: '';
        position: absolute;
        right: 100%;
        top: 50%;
        transform: translateY(-50%);
        border: 5px solid transparent;
        border-right-color: #333;
    }
    
    .source-info:hover .source-tooltip {
        opacity: 1;
    }
    
    /* Expandable row details */
    .row-details {
        display: none;
        background: #f8f9fa;
        border-top: 1px solid #dee2e6;
    }
    
    .row-details td {
        padding: 15px;
    }
    
    .details-content {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }
    
    .detail-item {
        background: white;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }
    
    .detail-label {
        font-weight: 600;
        color: #495057;
        font-size: 0.85em;
        margin-bottom: 3px;
    }
    
    .detail-value {
        color: #212529;
        font-size: 0.9em;
    }
    
    .expand-details {
        cursor: pointer;
        color: #007bff;
        font-size: 0.85em;
        text-decoration: underline;
    }
    
    .expand-details:hover {
        color: #0056b3;
    }
    
    /* Toast notification styles */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }
    
    .toast {
        background: white;
        border-radius: 8px;
        padding: 16px 24px;
        margin-bottom: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 300px;
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .toast.success {
        border-left: 4px solid #28a745;
    }
    
    .toast.error {
        border-left: 4px solid #dc3545;
    }
    
    .toast.info {
        border-left: 4px solid #17a2b8;
    }
    
    .toast-icon {
        font-size: 24px;
    }
    
    .toast.success .toast-icon {
        color: #28a745;
    }
    
    .toast.error .toast-icon {
        color: #dc3545;
    }
    
    .toast.info .toast-icon {
        color: #17a2b8;
    }
    
    .toast-content h4 {
        margin: 0 0 4px 0;
        font-size: 16px;
        font-weight: 600;
    }
    
    .toast-content p {
        margin: 0;
        font-size: 14px;
        color: #666;
    }
    
    .toast-close {
        margin-left: auto;
        background: none;
        border: none;
        font-size: 20px;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .toast-close:hover {
        color: #333;
    }
</style>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<div class="staging-container">
    <div class="staging-header">
        <h1>Recipe Staging Review</h1>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="bulkApproveValid()">
                Bulk Approve Valid Rows
            </button>
            <button class="btn btn-success" onclick="processToLive()">
                Commit Approved Records
            </button>
        </div>
    </div>
    
    <!-- Batch Statistics -->
    <div class="batch-stats" id="batchStats">
        <div class="stat-card">
            <h3 id="totalCount">{{ total }}</h3>
            <p>Total Records</p>
        </div>
        <div class="stat-card stat-success">
            <h3 id="approvedCount">{{ items|selectattr('review_status', 'equalto', 'approved')|list|length }}</h3>
            <p>Approved</p>
        </div>
        <div class="stat-card stat-warning">
            <h3 id="flaggedCount">{{ items|selectattr('needs_review', 'equalto', True)|list|length }}</h3>
            <p>Flagged</p>
        </div>
        <div class="stat-card">
            <h3 id="unapprovedCount">{{ items|selectattr('review_status', 'ne', 'approved')|selectattr('review_status', 'ne', 'rejected')|list|length }}</h3>
            <p>Unapproved</p>
        </div>
    </div>
    
    <!-- Issue Summary -->
    {% set low_food_cost_count = 0 %}
    {% set high_food_cost_count = 0 %}
    {% set low_margin_count = 0 %}
    {% set zero_price_count = 0 %}
    {% set draft_status_count = 0 %}
    {% set missing_fields_count = 0 %}
    
    {% for item in items %}
        {% if item.food_cost_percentage and item.food_cost_percentage < 10 %}
            {% set low_food_cost_count = low_food_cost_count + 1 %}
        {% endif %}
        {% if item.food_cost_percentage and item.food_cost_percentage > 40 %}
            {% set high_food_cost_count = high_food_cost_count + 1 %}
        {% endif %}
        {% if item.gross_margin and item.gross_margin < 60 %}
            {% set low_margin_count = low_margin_count + 1 %}
        {% endif %}
        {% if not item.menu_price or item.menu_price == 0 %}
            {% set zero_price_count = zero_price_count + 1 %}
        {% endif %}
        {% set problem_statuses = ['Draft', 'Test', 'draft', 'test'] %}
        {% if not item.status or item.status in problem_statuses %}
            {% set draft_status_count = draft_status_count + 1 %}
        {% endif %}
        {% if not item.recipe_name or not item.food_cost or (item.recipe_type == 'PrepRecipe' and (not item.yield_quantity or not item.yield_unit)) or not item.serving_size %}
            {% set missing_fields_count = missing_fields_count + 1 %}
        {% endif %}
    {% endfor %}
    
    {% set total_issues = low_food_cost_count + high_food_cost_count + low_margin_count + zero_price_count + draft_status_count + missing_fields_count %}
    
    {% if total_issues > 0 %}
    <div class="issue-summary">
        <h3>⚠️ Validation Summary</h3>
        <div class="issue-summary-grid">
            {% if low_food_cost_count > 0 %}
            <div class="issue-summary-item">
                <span class="issue-count">{{ low_food_cost_count }}</span>
                <span class="issue-label">Food Cost < 10%</span>
            </div>
            {% endif %}
            {% if high_food_cost_count > 0 %}
            <div class="issue-summary-item error-item">
                <span class="issue-count">{{ high_food_cost_count }}</span>
                <span class="issue-label">Food Cost > 40%</span>
            </div>
            {% endif %}
            {% if low_margin_count > 0 %}
            <div class="issue-summary-item">
                <span class="issue-count">{{ low_margin_count }}</span>
                <span class="issue-label">Margin < 60%</span>
            </div>
            {% endif %}
            {% if zero_price_count > 0 %}
            <div class="issue-summary-item error-item">
                <span class="issue-count">{{ zero_price_count }}</span>
                <span class="issue-label">$0 Menu Price</span>
            </div>
            {% endif %}
            {% if draft_status_count > 0 %}
            <div class="issue-summary-item">
                <span class="issue-count">{{ draft_status_count }}</span>
                <span class="issue-label">Draft/Test Status</span>
            </div>
            {% endif %}
            {% if missing_fields_count > 0 %}
            <div class="issue-summary-item error-item">
                <span class="issue-count">{{ missing_fields_count }}</span>
                <span class="issue-label">Missing Required Fields</span>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <!-- Filters -->
    <div class="filters-bar">
        <div class="filter-group">
            <label>Batch</label>
            <select id="batchFilter" onchange="applyFilters()">
                <option value="">All Batches</option>
                {% for batch in batches %}
                <option value="{{ batch.batch_id }}" {% if filters.batch_id == batch.batch_id %}selected{% endif %}>
                    {{ batch.batch_id }} ({{ batch.total_rows }} recipes)
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-group">
            <label>Status</label>
            <select id="statusFilter" onchange="applyFilters()">
                <option value="">All Statuses</option>
                <option value="pending" {% if filters.review_status == 'pending' %}selected{% endif %}>Pending</option>
                <option value="approved" {% if filters.review_status == 'approved' %}selected{% endif %}>Approved</option>
                <option value="rejected" {% if filters.review_status == 'rejected' %}selected{% endif %}>Rejected</option>
                <option value="hold" {% if filters.review_status == 'hold' %}selected{% endif %}>On Hold</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Review Required</label>
            <select id="reviewFilter" onchange="applyFilters()">
                <option value="">All</option>
                <option value="1" {% if filters.needs_review == 1 %}selected{% endif %}>Yes</option>
                <option value="0" {% if filters.needs_review == 0 %}selected{% endif %}>No</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Recipe Type</label>
            <select id="typeFilter" onchange="applyFilters()">
                <option value="">All Types</option>
                <option value="Recipe" {% if filters.recipe_type == 'Recipe' %}selected{% endif %}>Recipe</option>
                <option value="PrepRecipe" {% if filters.recipe_type == 'PrepRecipe' %}selected{% endif %}>Prep Recipe</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Search</label>
            <input type="text" id="searchFilter" placeholder="Search recipes..." 
                   value="{{ filters.search or '' }}" onkeyup="debounceSearch()">
        </div>
        
        <div class="filter-group">
            <label>Recipes per page</label>
            <select id="perPageFilter" onchange="applyFilters()">
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="75" {% if per_page == 75 %}selected{% endif %}>75</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                <option value="all" {% if per_page == 'all' or per_page > 1000 %}selected{% endif %}>All</option>
            </select>
        </div>
        
        <div class="filter-group">
            <button class="btn btn-primary" onclick="clearFilters()">Clear Filters</button>
        </div>
    </div>
    
    <!-- Column Mapping Panel -->
    <div class="column-mapping-panel">
        <h3>Column Mapping Reference</h3>
        <p class="mapping-subtitle">Understanding how xtraCHEF export columns are mapped to the application</p>
        <div class="mapping-grid">
            <div class="mapping-item">
                <span class="original-column">RecipeName</span>
                <span class="arrow">→</span>
                <span class="mapped-column">Recipe Name</span>
            </div>
            <div class="mapping-item">
                <span class="original-column">Type</span>
                <span class="arrow">→</span>
                <span class="mapped-column">Recipe Type</span>
            </div>
            <div class="mapping-item">
                <span class="original-column">Status</span>
                <span class="arrow">→</span>
                <span class="mapped-column">Status</span>
            </div>
            <div class="mapping-item">
                <span class="original-column">FoodCost</span>
                <span class="arrow">→</span>
                <span class="mapped-column">Food Cost</span>
            </div>
            <div class="mapping-item">
                <span class="original-column">FoodCostPercentage</span>
                <span class="arrow">→</span>
                <span class="mapped-column">Food Cost %</span>
            </div>
            <div class="mapping-item">
                <span class="original-column">MenuPrice</span>
                <span class="arrow">→</span>
                <span class="mapped-column">Menu Price</span>
            </div>
            <div class="mapping-item">
                <span class="original-column">GrossMargin</span>
                <span class="arrow">→</span>
                <span class="mapped-column">Gross Margin</span>
            </div>
            <div class="mapping-item">
                <span class="original-column">PrepRecipeYield</span>
                <span class="arrow">→</span>
                <span class="mapped-column">Yield</span>
            </div>
            <div class="mapping-item">
                <span class="original-column">PerServing</span>
                <span class="arrow">→</span>
                <span class="mapped-column">Per Serving</span>
            </div>
            <div class="mapping-item">
                <span class="original-column">LocationName</span>
                <span class="arrow">→</span>
                <span class="mapped-column">FAM Location Name</span>
            </div>
            <div class="mapping-item">
                <span class="original-column">RecipeGroup</span>
                <span class="arrow">→</span>
                <span class="mapped-column">Recipe Group</span>
            </div>
            <div class="mapping-item">
                <span class="original-column">LaborCost</span>
                <span class="arrow">→</span>
                <span class="mapped-column">Labor Cost</span>
            </div>
            <div class="mapping-item">
                <span class="original-column">LaborCostPercentage</span>
                <span class="arrow">→</span>
                <span class="mapped-column">Labor Cost %</span>
            </div>
            <div class="mapping-item">
                <span class="original-column">PrimeCost</span>
                <span class="arrow">→</span>
                <span class="mapped-column">Prime Cost</span>
            </div>
            <div class="mapping-item">
                <span class="original-column">PrimeCostPercentage</span>
                <span class="arrow">→</span>
                <span class="mapped-column">Prime Cost %</span>
            </div>
            <div class="mapping-item">
                <span class="original-column">CostModified</span>
                <span class="arrow">→</span>
                <span class="mapped-column">Date Cost Modified</span>
            </div>
            <div class="mapping-item">
                <span class="original-column">ShelfLife</span>
                <span class="arrow">→</span>
                <span class="mapped-column">Shelf Life</span>
            </div>
            <div class="mapping-item">
                <span class="original-column">ServingSize</span>
                <span class="arrow">→</span>
                <span class="mapped-column">Serving Size</span>
            </div>
        </div>
    </div>
    
    <!-- Review Table -->
    <div class="table-wrapper">
        <div class="scroll-hint">← Scroll horizontally to see all columns →</div>
        <div class="review-table">
        <table>
            <thead>
                <tr>
                    <th class="checkbox-col">
                        <input type="checkbox" class="select-all" onchange="toggleSelectAll(this)">
                    </th>
                    <th>Approved</th>
                    <th class="column-tooltip" data-original="RecipeName">Recipe Name</th>
                    <th class="column-tooltip" data-original="Type">Type</th>
                    <th class="column-tooltip" data-original="Status">Status</th>
                    <th class="column-tooltip" data-original="FoodCost">Food Cost</th>
                    <th class="column-tooltip" data-original="FoodCostPercentage">Food Cost %</th>
                    <th class="column-tooltip" data-original="MenuPrice">Menu Price</th>
                    <th class="column-tooltip" data-original="GrossMargin">Gross Margin</th>
                    <th class="column-tooltip" data-original="PrepRecipeYield">Yield</th>
                    <th class="column-tooltip" data-original="PerServing">Per Serving</th>
                    <th>Review Status</th>
                    <th>Validation Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                {% set issues = [] %}
                {% set severity = 'none' %}
                
                {# Check food cost percentage issues #}
                {% if item.food_cost_percentage %}
                    {% if item.food_cost_percentage < 10 %}
                        {% set _ = issues.append({'type': 'low_food_cost', 'message': 'Food cost < 10%', 'severity': 'warning'}) %}
                        {% set severity = 'warning' if severity == 'none' else severity %}
                    {% elif item.food_cost_percentage > 40 %}
                        {% set _ = issues.append({'type': 'high_food_cost', 'message': 'Food cost > 40%', 'severity': 'error'}) %}
                        {% set severity = 'error' %}
                    {% endif %}
                {% endif %}
                
                {# Check gross margin #}
                {% if item.gross_margin and item.gross_margin < 60 %}
                    {% set _ = issues.append({'type': 'low_margin', 'message': 'Gross margin < 60%', 'severity': 'warning'}) %}
                    {% set severity = 'warning' if severity == 'none' else severity %}
                {% endif %}
                
                {# Check menu price #}
                {% if not item.menu_price or item.menu_price == 0 %}
                    {% set _ = issues.append({'type': 'zero_price', 'message': 'Menu price is $0 or blank', 'severity': 'error'}) %}
                    {% set severity = 'error' %}
                {% endif %}
                
                {# Check recipe status #}
                {% set problem_statuses = ['Draft', 'Test', 'draft', 'test'] %}
                {% if not item.status or item.status in problem_statuses %}
                    {% set _ = issues.append({'type': 'draft_status', 'message': 'Recipe status: ' + (item.status or 'undefined'), 'severity': 'warning'}) %}
                    {% set severity = 'warning' if severity == 'none' else severity %}
                {% endif %}
                
                {# Check required fields #}
                {% if not item.recipe_name %}
                    {% set _ = issues.append({'type': 'missing_name', 'message': 'Missing recipe name', 'severity': 'error'}) %}
                    {% set severity = 'error' %}
                {% endif %}
                
                {% if not item.food_cost or item.food_cost == 0 %}
                    {% set _ = issues.append({'type': 'missing_cost', 'message': 'Missing food cost', 'severity': 'error'}) %}
                    {% set severity = 'error' %}
                {% endif %}
                
                {% if item.recipe_type == 'PrepRecipe' and (not item.yield_quantity or not item.yield_unit) %}
                    {% set _ = issues.append({'type': 'missing_yield', 'message': 'Prep recipe missing yield', 'severity': 'error'}) %}
                    {% set severity = 'error' %}
                {% endif %}
                
                {% if not item.serving_size %}
                    {% set _ = issues.append({'type': 'missing_serving', 'message': 'Missing serving size', 'severity': 'warning'}) %}
                    {% set severity = 'warning' if severity == 'none' else severity %}
                {% endif %}
                
                {# Check for duplicates #}
                {% if item.is_duplicate %}
                    {% set _ = issues.append({'type': 'duplicate', 'message': 'Duplicate recipe', 'severity': 'warning'}) %}
                    {% set severity = 'warning' if severity == 'none' else severity %}
                {% endif %}
                
                <tr data-id="{{ item.staging_id }}" class="{% if severity == 'error' %}row-has-errors{% elif severity == 'warning' %}row-has-warnings{% endif %} {% if item.needs_review %}needs-review{% endif %}" data-issues="{{ issues|tojson|e }}">
                    <td>
                        <input type="checkbox" class="item-select" value="{{ item.staging_id }}">
                        <div class="source-info">
                            <span class="source-info-icon" title="Source info">ℹ</span>
                            <div class="source-tooltip">
                                {% if item.source_filename %}File: {{ item.source_filename }}{% endif %}
                                {% if item.original_row_number %} • Row: {{ item.original_row_number }}{% endif %}
                            </div>
                        </div>
                        <span class="expand-details" onclick="toggleRowDetails({{ item.staging_id }})">Details ▼</span>
                    </td>
                    <td class="approval-cell">
                        <input type="checkbox" 
                               class="approval-checkbox" 
                               data-id="{{ item.staging_id }}"
                               {% if item.review_status == 'approved' %}checked{% endif %}
                               {% if severity == 'error' %}disabled title="Cannot approve items with critical validation issues"{% endif %}
                               onchange="toggleApproval({{ item.staging_id }}, this)">
                    </td>
                    <td>
                        <div class="editable" data-field="recipe_name">
                            {{ item.recipe_name or '' }}
                            {% if item.recipe_name_flag %}
                                <span class="flag-indicator flag-warning" title="{{ item.recipe_name_flag }}">!</span>
                            {% endif %}
                            {% if item.is_duplicate %}
                                <span class="flag-indicator flag-info" title="Duplicate recipe">D</span>
                            {% endif %}
                            {% if item.matched_recipe_id %}
                                <span class="flag-indicator flag-warning" title="Already exists in database">E</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {{ item.recipe_type or '' }}
                        {% if item.recipe_type_flag %}
                            <span class="flag-indicator flag-info" title="{{ item.recipe_type_flag }}">!</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-badge status-{{ (item.status or 'pending')|lower }}">
                            {{ item.status or 'Unknown' }}
                        </span>
                    </td>
                    <td>
                        <div class="editable" data-field="food_cost">
                            ${{ "%.2f"|format(item.food_cost or 0) }}
                            {% if item.food_cost_flag %}
                                <span class="flag-indicator flag-error" title="{{ item.food_cost_flag }}">!</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="editable" data-field="food_cost_percentage">
                            {{ "%.1f"|format(item.food_cost_percentage or 0) }}%
                            {% if item.food_cost_percentage_flag %}
                                <span class="flag-indicator flag-warning" title="{{ item.food_cost_percentage_flag }}">!</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="editable" data-field="menu_price">
                            ${{ "%.2f"|format(item.menu_price or 0) }}
                            {% if item.menu_price_flag %}
                                <span class="flag-indicator flag-warning" title="{{ item.menu_price_flag }}">!</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {{ "%.1f"|format(item.gross_margin or 0) }}%
                        {% if item.gross_margin_flag %}
                            <span class="flag-indicator flag-warning" title="{{ item.gross_margin_flag }}">!</span>
                        {% endif %}
                        {% if item.margin_variance and abs(item.margin_variance) > 5 %}
                            <span class="flag-indicator flag-error" title="Margin variance: {{ "%.1f"|format(item.margin_variance) }}%">V</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="editable" data-field="yield_quantity">
                            {{ item.yield_quantity or '-' }} {{ item.yield_unit or '' }}
                            {% if item.yield_quantity_flag %}
                                <span class="flag-indicator flag-info" title="{{ item.yield_quantity_flag }}">!</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        ${{ "%.2f"|format(item.per_serving or 0) }}
                        {% if item.per_serving_flag %}
                            <span class="flag-indicator flag-info" title="{{ item.per_serving_flag }}">!</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-badge status-{{ item.review_status or 'pending' }}">
                            {{ item.review_status or 'pending' }}
                        </span>
                    </td>
                    <td class="validation-notes-cell">
                        {% if issues %}
                            <div class="validation-notes">
                                {% if severity == 'error' %}
                                    <span class="validation-icon error-icon" title="{{ issues|length }} critical issue(s)">🛑</span>
                                {% else %}
                                    <span class="validation-icon warning-icon" title="{{ issues|length }} warning(s)">⚠️</span>
                                {% endif %}
                                <div class="validation-details">
                                    {% for issue in issues %}
                                        <span class="validation-badge {{ issue.severity }}-badge">{{ issue.message }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        {% else %}
                            <span class="validation-ok">✓ Valid</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="row-actions">
                            <button class="btn-action btn-edit" onclick="editItem({{ item.staging_id }})" title="Edit">
                                <span style="color: #007bff;">✏️</span>
                            </button>
                            <button class="btn-action btn-delete" onclick="deleteItem({{ item.staging_id }})" title="Delete">
                                <span style="color: #dc3545;">🗑</span>
                            </button>
                        </div>
                    </td>
                </tr>
                
                <!-- Expandable details row -->
                <tr class="expandable-row" id="details-{{ item.staging_id }}" style="display: none;">
                    <td colspan="13" class="details-cell">
                        <div class="details-content">
                            <div class="details-section">
                                <h4>Source Information</h4>
                                <div class="details-grid">
                                    <div class="detail-item">
                                        <label>Import Batch:</label>
                                        <span>{{ item.import_batch_id }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Source File:</label>
                                        <span>{{ item.source_filename or 'N/A' }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Original Row:</label>
                                        <span>{{ item.original_row_number or 'N/A' }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Created:</label>
                                        <span>{{ item.created_at|default('N/A') }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            {% if item.validation_errors %}
                            <div class="details-section">
                                <h4>Validation Details</h4>
                                <ul class="validation-list">
                                    {% for error in item.validation_errors %}
                                    <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                            
                            {% if item.review_notes %}
                            <div class="details-section">
                                <h4>Review Notes</h4>
                                <p>{{ item.review_notes }}</p>
                            </div>
                            {% endif %}
                            
                            <div class="details-section">
                                <h4>Raw Values</h4>
                                <div class="details-grid">
                                    {% if item.food_cost_raw %}
                                    <div class="detail-item">
                                        <label>Original Food Cost:</label>
                                        <span>{{ item.food_cost_raw }}</span>
                                    </div>
                                    {% endif %}
                                    {% if item.food_cost_percentage_raw %}
                                    <div class="detail-item">
                                        <label>Original Food Cost %:</label>
                                        <span>{{ item.food_cost_percentage_raw }}</span>
                                    </div>
                                    {% endif %}
                                    {% if item.menu_price_raw %}
                                    <div class="detail-item">
                                        <label>Original Menu Price:</label>
                                        <span>{{ item.menu_price_raw }}</span>
                                    </div>
                                    {% endif %}
                                    {% if item.gross_margin_raw %}
                                    <div class="detail-item">
                                        <label>Original Gross Margin:</label>
                                        <span>{{ item.gross_margin_raw }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    </div>
    
    <!-- Pagination -->
    {% if per_page != 'all' and total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
            <a href="?page={{ page - 1 }}&{{ request.query_string.decode() }}" class="page-link">Previous</a>
        {% else %}
            <span class="page-link disabled">Previous</span>
        {% endif %}
        
        <span>Page {{ page }} of {{ total_pages }}</span>
        
        {% if page < total_pages %}
            <a href="?page={{ page + 1 }}&{{ request.query_string.decode() }}" class="page-link">Next</a>
        {% else %}
            <span class="page-link disabled">Next</span>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Bulk Actions Bar -->
    <div class="bulk-actions" id="bulkActions">
        <div>
            <span class="selected-count">0</span> items selected
        </div>
        <div>
            <button class="btn btn-success" onclick="bulkAction('approve')">Approve Selected</button>
            <button class="btn btn-secondary" onclick="bulkAction('hold')">Hold Selected</button>
            <button class="btn btn-danger" onclick="bulkAction('reject')">Reject Selected</button>
        </div>
    </div>
</div>

<script>
// Global variables
let selectedItems = new Set();
let searchTimeout;

// Toggle select all
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.item-select');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        if (checkbox.checked) {
            selectedItems.add(cb.value);
        } else {
            selectedItems.delete(cb.value);
        }
    });
    updateBulkActions();
}

// Handle individual checkbox changes
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('item-select')) {
        if (e.target.checked) {
            selectedItems.add(e.target.value);
        } else {
            selectedItems.delete(e.target.value);
        }
        updateBulkActions();
    }
});

// Update bulk actions bar
function updateBulkActions() {
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.querySelector('.selected-count');
    
    if (selectedItems.size > 0) {
        bulkActions.classList.add('show');
        selectedCount.textContent = selectedItems.size;
    } else {
        bulkActions.classList.remove('show');
    }
}

// Apply filters
function applyFilters() {
    const params = new URLSearchParams();
    
    const batch = document.getElementById('batchFilter').value;
    if (batch) params.append('batch_id', batch);
    
    const status = document.getElementById('statusFilter').value;
    if (status) params.append('review_status', status);
    
    const review = document.getElementById('reviewFilter').value;
    if (review !== '') params.append('needs_review', review);
    
    const type = document.getElementById('typeFilter').value;
    if (type) params.append('recipe_type', type);
    
    const search = document.getElementById('searchFilter').value;
    if (search) params.append('search', search);
    
    const perPage = document.getElementById('perPageFilter').value;
    if (perPage && perPage !== '50') params.append('per_page', perPage);
    
    window.location.href = '?' + params.toString();
}

// Debounce search
function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(applyFilters, 500);
}

// Clear filters
function clearFilters() {
    window.location.href = window.location.pathname;
}

// Inline editing
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('editable') && !e.target.classList.contains('editing')) {
        const field = e.target.dataset.field;
        const currentValue = e.target.textContent.trim();
        const row = e.target.closest('tr');
        const itemId = row.dataset.id;
        
        // Remove any flag indicators from the value
        const cleanValue = currentValue.replace(/[!DEvV]$/, '').replace(/[$%]/g, '').trim();
        
        e.target.classList.add('editing');
        e.target.innerHTML = `<input type="text" class="edit-input" value="${cleanValue}" data-field="${field}" data-id="${itemId}">`;
        
        const input = e.target.querySelector('.edit-input');
        input.focus();
        input.select();
        
        input.addEventListener('blur', saveEdit);
        input.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                saveEdit.call(this);
            }
        });
    }
});

// Save inline edit
function saveEdit() {
    const field = this.dataset.field;
    const itemId = this.dataset.id;
    const newValue = this.value;
    const parent = this.parentElement;
    
    // Send update to server
    fetch(`/admin/recipe-staging/item/${itemId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            [field]: newValue
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            parent.classList.remove('editing');
            parent.textContent = newValue;
            // Could add a success indicator
        } else {
            alert('Failed to update item');
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update item');
        location.reload();
    });
}

// Bulk actions
function bulkAction(action) {
    if (selectedItems.size === 0) return;
    
    const message = action === 'approve' 
        ? `Approve ${selectedItems.size} items?` 
        : action === 'hold'
        ? `Hold ${selectedItems.size} items?`
        : `Reject ${selectedItems.size} items?`;
    
    if (!confirm(message)) return;
    
    fetch('/admin/recipe-staging/batch-action', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            staging_ids: Array.from(selectedItems),
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success > 0) {
            alert(`Successfully ${action}d ${data.success} items`);
            location.reload();
        } else {
            alert('Failed to update items');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update items');
    });
}

// Individual row actions
function approveItem(itemId) {
    updateItemStatus(itemId, 'approve');
}

function holdItem(itemId) {
    updateItemStatus(itemId, 'hold');
}

function rejectItem(itemId) {
    updateItemStatus(itemId, 'reject');
}

function deleteItem(itemId) {
    if (confirm('Are you sure you want to delete this item?')) {
        updateItemStatus(itemId, 'delete');
    }
}

function updateItemStatus(itemId, action) {
    fetch('/admin/recipe-staging/batch-action', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            staging_ids: [itemId.toString()],
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success > 0) {
            // Reload the page to show updated status
            location.reload();
        } else {
            alert('Failed to update item');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update item');
    });
}

// Bulk approve all valid rows
function bulkApproveValid() {
    // Find all rows that don't have issues
    const validRows = document.querySelectorAll('tr:not(.row-has-warnings):not(.row-has-errors)');
    const validIds = [];
    
    validRows.forEach(row => {
        const checkbox = row.querySelector('.item-select');
        if (checkbox && row.dataset.id) {
            // Check if not already approved
            const statusBadge = row.querySelector('.status-badge');
            if (statusBadge && !statusBadge.classList.contains('status-approved')) {
                validIds.push(row.dataset.id);
            }
        }
    });
    
    if (validIds.length === 0) {
        alert('No valid rows to approve');
        return;
    }
    
    if (!confirm(`Approve ${validIds.length} valid rows?`)) return;
    
    fetch('/admin/recipe-staging/batch-action', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            staging_ids: validIds,
            action: 'approve'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success > 0) {
            alert(`Successfully approved ${data.success} items`);
            location.reload();
        } else {
            alert('Failed to approve items');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to approve items');
    });
}

// Process to live
function processToLive() {
    // First, get count of approved items without validation issues
    const approvedValidRows = document.querySelectorAll('tr[data-id]').length > 0 ? 
        Array.from(document.querySelectorAll('tr[data-id]')).filter(row => {
            const checkbox = row.querySelector('.approval-checkbox');
            const hasErrors = row.classList.contains('row-error');
            const hasWarnings = row.classList.contains('row-warning');
            return checkbox && checkbox.checked && !hasErrors && !hasWarnings;
        }).length : 0;
    
    if (approvedValidRows === 0) {
        showToast('info', 'No Records to Commit', 'There are no approved recipes without validation issues to commit.');
        return;
    }
    
    const batch = document.getElementById('batchFilter').value;
    const message = batch 
        ? `Commit ${approvedValidRows} approved recipes from this batch to live recipes?` 
        : `Commit ${approvedValidRows} approved recipes to live recipes?`;
    
    if (!confirm(message)) return;
    
    // Show processing toast
    showToast('info', 'Processing', 'Committing approved recipes to live database...');
    
    fetch('/admin/recipe-staging/process-to-live', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            batch_id: batch || null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.processed > 0) {
            showToast('success', 'Recipes Committed Successfully', 
                `${data.processed} recipes have been committed to the live database.${data.errors > 0 ? ` ${data.errors} recipes had errors.` : ''}`);
            
            // Reload after a short delay to let user see the success message
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showToast('error', 'No Recipes Processed', 
                `No recipes were committed. ${data.errors > 0 ? `${data.errors} recipes had errors.` : 'Please check the recipes and try again.'}`);
        }
        
        if (data.details && data.details.length > 0) {
            console.log('Processing details:', data.details);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Processing Failed', 'Failed to commit recipes. Please try again.');
    });
}

// Toggle approval checkbox
function toggleRowDetails(itemId) {
    const detailsRow = document.getElementById(`details-${itemId}`);
    const expandLink = event.target;
    
    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
        expandLink.textContent = 'Details ▲';
    } else {
        detailsRow.style.display = 'none';
        expandLink.textContent = 'Details ▼';
    }
}

// Toast notification system
function showToast(type, title, message) {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const icons = {
        success: '✓',
        error: '✗',
        info: 'ℹ'
    };
    
    toast.innerHTML = `
        <span class="toast-icon">${icons[type]}</span>
        <div class="toast-content">
            <h4>${title}</h4>
            <p>${message}</p>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">×</button>
    `;
    
    toastContainer.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// Update statistics counts
function updateStatistics() {
    const rows = document.querySelectorAll('tbody tr:not(.expandable-row)');
    let total = 0;
    let approved = 0;
    let flagged = 0;
    let unapproved = 0;
    
    rows.forEach(row => {
        // Skip hidden rows (filtered out)
        if (row.style.display === 'none') return;
        
        total++;
        
        const checkbox = row.querySelector('.approval-checkbox');
        const hasIssues = row.classList.contains('row-warning') || row.classList.contains('row-error');
        
        if (checkbox && checkbox.checked) {
            approved++;
        } else if (hasIssues) {
            flagged++;
        } else {
            unapproved++;
        }
    });
    
    // Update the display
    document.getElementById('totalCount').textContent = total;
    document.getElementById('approvedCount').textContent = approved;
    document.getElementById('flaggedCount').textContent = flagged;
    document.getElementById('unapprovedCount').textContent = unapproved;
}

function toggleApproval(itemId, checkbox) {
    const isApproved = checkbox.checked;
    const action = isApproved ? 'approved' : 'pending';
    
    fetch(`/admin/recipe-staging/item/${itemId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            review_status: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the status badge
            const row = document.querySelector(`tr[data-id="${itemId}"]`);
            const statusBadge = row.querySelector('.status-badge');
            if (statusBadge) {
                statusBadge.className = `status-badge status-${action}`;
                statusBadge.textContent = action;
            }
            // Update statistics after approval change
            updateStatistics();
        } else {
            // Revert checkbox on failure
            checkbox.checked = !isApproved;
            alert('Failed to update approval status');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        checkbox.checked = !isApproved;
        alert('Failed to update approval status');
    });
}

// Edit modal functions
function editItem(itemId) {
    // Fetch item data
    fetch(`/admin/recipe-staging/item/${itemId}`)
        .then(response => response.json())
        .then(data => {
            // Populate the form
            document.getElementById('edit_staging_id').value = itemId;
            document.getElementById('edit_recipe_name').value = data.recipe_name || '';
            document.getElementById('edit_recipe_type').value = data.recipe_type || 'Recipe';
            document.getElementById('edit_status').value = data.status || '';
            document.getElementById('edit_food_cost').value = data.food_cost || 0;
            document.getElementById('edit_food_cost_percentage').value = data.food_cost_percentage || 0;
            document.getElementById('edit_menu_price').value = data.menu_price || 0;
            document.getElementById('edit_gross_margin').value = data.gross_margin || 0;
            document.getElementById('edit_yield_quantity').value = data.yield_quantity || '';
            document.getElementById('edit_yield_unit').value = data.yield_unit || '';
            document.getElementById('edit_serving_size').value = data.serving_size || '';
            document.getElementById('edit_serving_size_uom').value = data.serving_size_uom || '';
            document.getElementById('edit_review_status').value = data.review_status || 'pending';
            document.getElementById('edit_validation_notes').value = data.validation_notes || '';
            
            // Show the modal
            document.getElementById('editModal').style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load recipe data');
        });
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

function saveEditItem() {
    const form = document.getElementById('editForm');
    const formData = new FormData(form);
    const itemId = formData.get('staging_id');
    
    // Convert form data to JSON
    const data = {};
    for (let [key, value] of formData.entries()) {
        if (key !== 'staging_id') {
            data[key] = value;
        }
    }
    
    fetch(`/admin/recipe-staging/item/${itemId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Recipe updated successfully');
            closeEditModal();
            // Reload the page to show updated data
            window.location.reload();
        } else {
            alert('Failed to update recipe: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update recipe');
    });
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('editModal');
    if (event.target == modal) {
        closeEditModal();
    }
}

// Add keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + A to select all visible
    if ((e.ctrlKey || e.metaKey) && e.key === 'a' && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        document.querySelector('.select-all').click();
    }
    
    // Delete key to reject selected
    if (e.key === 'Delete' && selectedItems.size > 0 && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        bulkAction('reject');
    }
    
    // Escape key to close modal
    if (e.key === 'Escape') {
        closeEditModal();
    }
});
</script>

<!-- Edit Modal -->
<div id="editModal" class="edit-modal">
    <div class="edit-modal-content">
        <div class="edit-modal-header">
            <h2>Edit Recipe</h2>
            <button class="close-modal" onclick="closeEditModal()">&times;</button>
        </div>
        <form id="editForm">
            <input type="hidden" id="edit_staging_id" name="staging_id">
            
            <div class="edit-form-group">
                <label for="edit_recipe_name">Recipe Name</label>
                <input type="text" id="edit_recipe_name" name="recipe_name" required>
            </div>
            
            <div class="edit-form-group">
                <label for="edit_recipe_type">Recipe Type</label>
                <select id="edit_recipe_type" name="recipe_type">
                    <option value="Recipe">Recipe</option>
                    <option value="PrepRecipe">Prep Recipe</option>
                </select>
            </div>
            
            <div class="edit-form-group">
                <label for="edit_status">Status</label>
                <select id="edit_status" name="status">
                    <option value="Active">Active</option>
                    <option value="Draft">Draft</option>
                    <option value="Test">Test</option>
                    <option value="Inactive">Inactive</option>
                </select>
            </div>
            
            <div class="edit-form-group">
                <label for="edit_food_cost">Food Cost ($)</label>
                <input type="number" id="edit_food_cost" name="food_cost" step="0.01" min="0">
            </div>
            
            <div class="edit-form-group">
                <label for="edit_food_cost_percentage">Food Cost %</label>
                <input type="number" id="edit_food_cost_percentage" name="food_cost_percentage" step="0.1" min="0" max="100">
            </div>
            
            <div class="edit-form-group">
                <label for="edit_menu_price">Menu Price ($)</label>
                <input type="number" id="edit_menu_price" name="menu_price" step="0.01" min="0">
            </div>
            
            <div class="edit-form-group">
                <label for="edit_gross_margin">Gross Margin (%)</label>
                <input type="number" id="edit_gross_margin" name="gross_margin" step="0.1" min="0" max="100">
            </div>
            
            <div class="edit-form-group">
                <label for="edit_yield_quantity">Yield Quantity</label>
                <input type="number" id="edit_yield_quantity" name="yield_quantity" step="0.01" min="0">
            </div>
            
            <div class="edit-form-group">
                <label for="edit_yield_unit">Yield Unit</label>
                <input type="text" id="edit_yield_unit" name="yield_unit">
            </div>
            
            <div class="edit-form-group">
                <label for="edit_serving_size">Serving Size</label>
                <input type="number" id="edit_serving_size" name="serving_size" step="0.01" min="0">
            </div>
            
            <div class="edit-form-group">
                <label for="edit_serving_size_uom">Serving Size UOM</label>
                <input type="text" id="edit_serving_size_uom" name="serving_size_uom">
            </div>
            
            <div class="edit-form-group">
                <label for="edit_review_status">Review Status</label>
                <select id="edit_review_status" name="review_status">
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                    <option value="hold">On Hold</option>
                </select>
            </div>
            
            <div class="edit-form-group">
                <label for="edit_validation_notes">Validation Notes</label>
                <textarea id="edit_validation_notes" name="validation_notes" rows="3"></textarea>
            </div>
        </form>
        
        <div class="edit-modal-footer">
            <button class="btn-edit-action btn-cancel" onclick="closeEditModal()">Cancel</button>
            <button class="btn-edit-action btn-save" onclick="saveEditItem()">Save Changes</button>
        </div>
    </div>
</div>

<script>
// Initialize statistics on page load
document.addEventListener('DOMContentLoaded', function() {
    updateStatistics();
});
</script>

{% endblock %}