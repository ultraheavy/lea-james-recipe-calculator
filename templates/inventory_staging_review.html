{% extends "base_modern.html" %}

{% block title %}Inventory Staging Review{% endblock %}

{% block content %}
<style>
    .staging-container {
        padding: 20px;
        max-width: 100%;
    }
    
    .staging-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 20px;
    }
    
    .batch-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        text-align: center;
    }
    
    .stat-card h3 {
        margin: 0;
        font-size: 2em;
        color: var(--primary-color);
    }
    
    .stat-card p {
        margin: 5px 0 0;
        color: var(--text-secondary);
        font-size: 0.9em;
    }
    
    .stat-card.stat-warning {
        background: #fff3cd;
        border-color: #ffeaa7;
    }
    
    .stat-card.stat-warning h3 {
        color: #856404;
    }
    
    .stat-card.stat-success {
        background: #d4edda;
        border-color: #c3e6cb;
    }
    
    .stat-card.stat-success h3 {
        color: #155724;
    }
    
    .stat-card.stat-danger {
        background: #f8d7da;
        border-color: #f5c6cb;
    }
    
    .stat-card.stat-danger h3 {
        color: #721c24;
    }
    
    .filters-bar {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: end;
    }
    
    .filter-group {
        flex: 1;
        min-width: 200px;
    }
    
    .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 0.9em;
        color: var(--text-secondary);
    }
    
    .review-table {
        background: var(--card-bg);
        border-radius: 8px;
        overflow-x: auto !important;
        overflow-y: visible;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        -webkit-overflow-scrolling: touch; /* smooth scrolling on mobile */
        max-width: 100%;
    }
    
    /* Make scrollbar more visible */
    .review-table::-webkit-scrollbar {
        height: 12px;
    }
    
    .review-table::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 6px;
    }
    
    .review-table::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 6px;
    }
    
    .review-table::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    .review-table table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .review-table th {
        background: var(--table-header-bg);
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: var(--text-primary);
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .review-table td {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .review-table tr:hover {
        background: var(--hover-bg);
    }
    
    /* Highlighting for problematic rows */
    .review-table tr.has-missing-fields {
        background-color: #fff3cd !important;
    }
    
    .review-table tr.has-zero-cost {
        background-color: #f8d7da !important;
    }
    
    .review-table tr.is-duplicate {
        background-color: #cfe2ff !important;
    }
    
    .review-table tr.has-multiple-issues {
        background: repeating-linear-gradient(
            45deg,
            #fff3cd,
            #fff3cd 10px,
            #f8d7da 10px,
            #f8d7da 20px
        ) !important;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 500;
    }
    
    .status-pending {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-approved {
        background: #d4edda;
        color: #155724;
    }
    
    .status-rejected {
        background: #f8d7da;
        color: #721c24;
    }
    
    .flag-indicator {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        text-align: center;
        line-height: 20px;
        font-size: 12px;
        font-weight: bold;
        cursor: help;
        margin-left: 5px;
    }
    
    .flag-error {
        background: #dc3545;
        color: white;
    }
    
    .flag-warning {
        background: #ffc107;
        color: #212529;
    }
    
    .flag-info {
        background: #17a2b8;
        color: white;
    }
    
    .editable {
        cursor: pointer;
        position: relative;
        padding: 2px 4px;
        border-radius: 3px;
        transition: background 0.2s;
    }
    
    .editable:hover {
        background: var(--hover-bg);
    }
    
    .editable.editing {
        background: #fff;
        box-shadow: 0 0 0 2px var(--primary-color);
    }
    
    .edit-input {
        border: none;
        background: transparent;
        width: 100%;
        padding: 2px 4px;
        font: inherit;
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
    }
    
    .btn-primary {
        background: var(--primary-color);
        color: white;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn:hover {
        opacity: 0.8;
        transform: translateY(-1px);
    }
    
    .checkbox-col {
        width: 40px;
    }
    
    .row-actions {
        display: flex;
        gap: 5px;
        justify-content: center;
    }
    
    .btn-action {
        background: transparent;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.2s;
    }
    
    .btn-action:hover {
        background: var(--hover-bg);
        transform: scale(1.1);
    }
    
    .btn-approve:hover {
        border-color: #28a745;
        background: #d4edda;
    }
    
    .btn-reject:hover {
        border-color: #dc3545;
        background: #f8d7da;
    }
    
    .btn-delete:hover {
        border-color: #6c757d;
        background: #e2e3e5;
    }
    
    .select-all {
        cursor: pointer;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 30px;
    }
    
    .page-link {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        text-decoration: none;
        color: var(--text-primary);
        transition: all 0.2s;
    }
    
    .page-link:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .page-link.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .page-link.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .tooltip {
        position: absolute;
        background: #333;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 1000;
        white-space: nowrap;
        display: none;
    }
    
    .bulk-actions {
        position: sticky;
        bottom: 0;
        background: var(--card-bg);
        padding: 15px;
        border-top: 2px solid var(--border-color);
        display: none;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }
    
    .bulk-actions.show {
        display: flex;
    }
    
    .selected-count {
        font-weight: 600;
        color: var(--primary-color);
    }
    
    .flags-detail {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .flags-detail:hover {
        overflow: visible;
        white-space: normal;
        background: var(--card-bg);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 8px;
        border-radius: 4px;
        position: absolute;
        z-index: 100;
        max-width: 500px;
    }
    
    .table-wrapper {
        position: relative;
    }
    
    .scroll-hint {
        text-align: center;
        color: #666;
        font-size: 14px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 10px;
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
</style>

<div class="staging-container">
    <div class="staging-header">
        <h1>Inventory Staging Review</h1>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="bulkApproveValid()">
                Bulk Approve Valid Rows
            </button>
            <button class="btn btn-success" onclick="processToLive()">
                Commit Approved Rows to Live DB
            </button>
        </div>
    </div>
    
    <!-- Batch Statistics -->
    <div class="batch-stats">
        <div class="stat-card">
            <h3>{{ total }}</h3>
            <p>Total Items</p>
        </div>
        <div class="stat-card stat-warning">
            <h3>{{ items|selectattr('needs_review', 'equalto', True)|list|length }}</h3>
            <p>Flagged Rows</p>
        </div>
        <div class="stat-card stat-success">
            <h3>{{ items|selectattr('review_status', 'equalto', 'approved')|selectattr('needs_review', 'equalto', False)|list|length }}</h3>
            <p>Ready to Commit</p>
        </div>
        <div class="stat-card stat-danger">
            <h3>{{ items|selectattr('review_status', 'equalto', 'rejected')|list|length }}</h3>
            <p>Rejected</p>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="filters-bar">
        <div class="filter-group">
            <label>Batch</label>
            <select id="batchFilter" onchange="applyFilters()">
                <option value="">All Batches</option>
                {% for batch in batches %}
                <option value="{{ batch.batch_id }}" {% if filters.batch_id == batch.batch_id %}selected{% endif %}>
                    {{ batch.batch_id }} ({{ batch.total_rows }} items)
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-group">
            <label>Status</label>
            <select id="statusFilter" onchange="applyFilters()">
                <option value="">All Statuses</option>
                <option value="pending" {% if filters.review_status == 'pending' %}selected{% endif %}>Pending</option>
                <option value="approved" {% if filters.review_status == 'approved' %}selected{% endif %}>Approved</option>
                <option value="rejected" {% if filters.review_status == 'rejected' %}selected{% endif %}>Rejected</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Review Required</label>
            <select id="reviewFilter" onchange="applyFilters()">
                <option value="">All</option>
                <option value="1" {% if filters.needs_review == 1 %}selected{% endif %}>Yes</option>
                <option value="0" {% if filters.needs_review == 0 %}selected{% endif %}>No</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Search</label>
            <input type="text" id="searchFilter" placeholder="Search items..." 
                   value="{{ filters.search or '' }}" onkeyup="debounceSearch()">
        </div>
        
        <div class="filter-group">
            <label>Items per page</label>
            <select id="perPageFilter" onchange="applyFilters()">
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="75" {% if per_page == 75 %}selected{% endif %}>75</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                <option value="all" {% if per_page == 'all' or per_page > 1000 %}selected{% endif %}>All</option>
            </select>
        </div>
        
        <div class="filter-group">
            <button class="btn btn-primary" onclick="clearFilters()">Clear Filters</button>
        </div>
    </div>
    
    <!-- Review Table -->
    <div class="table-wrapper">
        <div class="scroll-hint">‚Üê Scroll horizontally to see all columns ‚Üí</div>
        <div class="review-table">
        <table>
            <thead>
                <tr>
                    <th class="checkbox-col">
                        <input type="checkbox" class="select-all" onchange="toggleSelectAll(this)">
                    </th>
                    <th>FAM Product Name</th>
                    <th>FAM Restaurant Location</th>
                    <th>Vendor Name</th>
                    <th>Vendor Item Code</th>
                    <th>Vendor Item Description</th>
                    <th>Vendor UOM</th>
                    <th>Inventory UOM</th>
                    <th>Pack Qty</th>
                    <th>Size Qty</th>
                    <th>Size UOM</th>
                    <th>Last Purchased Date</th>
                    <th>Last Purchased Price</th>
                    <th>Review Status</th>
                    <th>Flags</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                {% set has_missing_fields = false %}
                {% set has_zero_cost = false %}
                {% set is_duplicate = item.is_duplicate %}
                
                {# Check for missing required fields #}
                {% if not item.FAM_Product_Name_cleaned or not item.Vendor_UOM_cleaned or not item.Inventory_UOM_cleaned or not item.Size_UOM_cleaned %}
                    {% set has_missing_fields = true %}
                {% endif %}
                
                {# Check for zero or missing cost #}
                {% if not item.Last_Purchased_Price_cleaned or item.Last_Purchased_Price_cleaned == 0 %}
                    {% set has_zero_cost = true %}
                {% endif %}
                
                <tr data-id="{{ item.staging_id }}" class="{% if item.needs_review %}needs-review{% endif %} {% if has_missing_fields %}has-missing-fields{% endif %} {% if has_zero_cost %}has-zero-cost{% endif %} {% if is_duplicate %}is-duplicate{% endif %}">
                    <td>
                        <input type="checkbox" class="item-select" value="{{ item.staging_id }}">
                    </td>
                    <td>
                        <div class="editable" data-field="FAM_Product_Name_cleaned">
                            {{ item.FAM_Product_Name_cleaned or item.FAM_Product_Name_raw or '' }}
                            {% if item.FAM_Product_Name_flag %}
                                <span class="flag-indicator flag-warning" title="{{ item.FAM_Product_Name_flag }}">!</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {{ item.FAM_Restaurant_Location_Name_cleaned or '' }}
                        {% if item.FAM_Restaurant_Location_Name_flag %}
                            <span class="flag-indicator flag-info" title="{{ item.FAM_Restaurant_Location_Name_flag }}">!</span>
                        {% endif %}
                    </td>
                    <td>
                        {{ item.Vendor_Name_cleaned or '' }}
                        {% if item.Vendor_Name_flag %}
                            <span class="flag-indicator flag-warning" title="{{ item.Vendor_Name_flag }}">!</span>
                        {% endif %}
                    </td>
                    <td>
                        {{ item.Vendor_Item_Code_cleaned or '' }}
                        {% if item.Vendor_Item_Code_flag %}
                            <span class="flag-indicator flag-warning" title="{{ item.Vendor_Item_Code_flag }}">!</span>
                        {% endif %}
                    </td>
                    <td title="{{ item.Vendor_Item_Description_cleaned or '' }}">
                        {{ (item.Vendor_Item_Description_cleaned or '')[:30] }}{% if (item.Vendor_Item_Description_cleaned or '')|length > 30 %}...{% endif %}
                        {% if item.Vendor_Item_Description_flag %}
                            <span class="flag-indicator flag-info" title="{{ item.Vendor_Item_Description_flag }}">!</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="editable" data-field="Vendor_UOM_cleaned">
                            {{ item.Vendor_UOM_cleaned or '-' }}
                            {% if item.Vendor_UOM_flag %}
                                <span class="flag-indicator flag-warning" title="{{ item.Vendor_UOM_flag }}">!</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="editable" data-field="Inventory_UOM_cleaned">
                            {{ item.Inventory_UOM_cleaned or '-' }}
                            {% if item.Inventory_UOM_flag %}
                                <span class="flag-indicator flag-warning" title="{{ item.Inventory_UOM_flag }}">!</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="editable" data-field="Pack_qty_cleaned">
                            {{ item.Pack_qty_cleaned or 1 }}
                            {% if item.Pack_qty_flag %}
                                <span class="flag-indicator flag-info" title="{{ item.Pack_qty_flag }}">!</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="editable" data-field="Size_qty_cleaned">
                            {{ item.Size_qty_cleaned or 1 }}
                            {% if item.Size_qty_flag %}
                                <span class="flag-indicator flag-info" title="{{ item.Size_qty_flag }}">!</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="editable" data-field="Size_UOM_cleaned">
                            {{ item.Size_UOM_cleaned or '-' }}
                            {% if item.Size_UOM_flag %}
                                <span class="flag-indicator flag-warning" title="{{ item.Size_UOM_flag }}">!</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {{ item.Last_Purchased_Date_cleaned or item.Last_Purchased_Date_raw or '' }}
                        {% if item.Last_Purchased_Date_flag %}
                            <span class="flag-indicator flag-info" title="{{ item.Last_Purchased_Date_flag }}">!</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="editable" data-field="Last_Purchased_Price_cleaned">
                            ${{ "%.2f"|format(item.Last_Purchased_Price_cleaned or 0) }}
                            {% if item.Last_Purchased_Price_flag %}
                                <span class="flag-indicator flag-warning" title="{{ item.Last_Purchased_Price_flag }}">!</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <span class="status-badge status-{{ item.review_status or 'pending' }}">
                            {{ item.review_status or 'pending' }}
                        </span>
                    </td>
                    <td>
                        {% if item.needs_review %}
                            <div class="flags-detail" title="{{ item.review_notes }}">
                                <span class="flag-indicator flag-error">!</span>
                                <small>{{ (item.review_notes or '')[:50] }}...</small>
                            </div>
                        {% else %}
                            <span style="color: #28a745;">‚úì</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="row-actions">
                            {% if item.review_status != 'approved' %}
                                <button class="btn-action btn-approve" onclick="approveItem({{ item.staging_id }})" title="Approve">
                                    <span style="color: #28a745;">‚úì</span>
                                </button>
                            {% endif %}
                            {% if item.review_status != 'rejected' %}
                                <button class="btn-action btn-reject" onclick="rejectItem({{ item.staging_id }})" title="Reject">
                                    <span style="color: #dc3545;">‚úó</span>
                                </button>
                            {% endif %}
                            <button class="btn-action btn-delete" onclick="deleteItem({{ item.staging_id }})" title="Delete">
                                <span style="color: #6c757d;">üóë</span>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    </div>
    
    <!-- Pagination -->
    {% if per_page != 'all' and total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
            <a href="?page={{ page - 1 }}&{{ request.query_string.decode() }}" class="page-link">Previous</a>
        {% else %}
            <span class="page-link disabled">Previous</span>
        {% endif %}
        
        <span>Page {{ page }} of {{ total_pages }}</span>
        
        {% if page < total_pages %}
            <a href="?page={{ page + 1 }}&{{ request.query_string.decode() }}" class="page-link">Next</a>
        {% else %}
            <span class="page-link disabled">Next</span>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Bulk Actions Bar -->
    <div class="bulk-actions" id="bulkActions">
        <div>
            <span class="selected-count">0</span> items selected
        </div>
        <div>
            <button class="btn btn-success" onclick="bulkAction('approve')">Approve Selected</button>
            <button class="btn btn-danger" onclick="bulkAction('reject')">Reject Selected</button>
        </div>
    </div>
</div>

<script>
// Global variables
let selectedItems = new Set();
let searchTimeout;

// Toggle select all
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.item-select');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        if (checkbox.checked) {
            selectedItems.add(cb.value);
        } else {
            selectedItems.delete(cb.value);
        }
    });
    updateBulkActions();
}

// Handle individual checkbox changes
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('item-select')) {
        if (e.target.checked) {
            selectedItems.add(e.target.value);
        } else {
            selectedItems.delete(e.target.value);
        }
        updateBulkActions();
    }
});

// Update bulk actions bar
function updateBulkActions() {
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.querySelector('.selected-count');
    
    if (selectedItems.size > 0) {
        bulkActions.classList.add('show');
        selectedCount.textContent = selectedItems.size;
    } else {
        bulkActions.classList.remove('show');
    }
}

// Apply filters
function applyFilters() {
    const params = new URLSearchParams();
    
    const batch = document.getElementById('batchFilter').value;
    if (batch) params.append('batch_id', batch);
    
    const status = document.getElementById('statusFilter').value;
    if (status) params.append('review_status', status);
    
    const review = document.getElementById('reviewFilter').value;
    if (review !== '') params.append('needs_review', review);
    
    const search = document.getElementById('searchFilter').value;
    if (search) params.append('search', search);
    
    const perPage = document.getElementById('perPageFilter').value;
    if (perPage && perPage !== '50') params.append('per_page', perPage);
    
    window.location.href = '?' + params.toString();
}

// Debounce search
function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(applyFilters, 500);
}

// Clear filters
function clearFilters() {
    window.location.href = window.location.pathname;
}

// Inline editing
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('editable') && !e.target.classList.contains('editing')) {
        const field = e.target.dataset.field;
        const currentValue = e.target.textContent.trim();
        const row = e.target.closest('tr');
        const itemId = row.dataset.id;
        
        // Remove any flag indicators from the value
        const cleanValue = currentValue.replace(/!$/, '').trim();
        
        e.target.classList.add('editing');
        e.target.innerHTML = `<input type="text" class="edit-input" value="${cleanValue}" data-field="${field}" data-id="${itemId}">`;
        
        const input = e.target.querySelector('.edit-input');
        input.focus();
        input.select();
        
        input.addEventListener('blur', saveEdit);
        input.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                saveEdit.call(this);
            }
        });
    }
});

// Save inline edit
function saveEdit() {
    const field = this.dataset.field;
    const itemId = this.dataset.id;
    const newValue = this.value;
    const parent = this.parentElement;
    
    // Send update to server
    fetch(`/admin/inventory-staging/item/${itemId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            [field]: newValue
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            parent.classList.remove('editing');
            parent.textContent = newValue;
            // Could add a success indicator
        } else {
            alert('Failed to update item');
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update item');
        location.reload();
    });
}

// Bulk actions
function bulkAction(action) {
    if (selectedItems.size === 0) return;
    
    const message = action === 'approve' 
        ? `Approve ${selectedItems.size} items?` 
        : `Reject ${selectedItems.size} items?`;
    
    if (!confirm(message)) return;
    
    fetch('/admin/inventory-staging/batch-action', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            staging_ids: Array.from(selectedItems),
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success > 0) {
            alert(`Successfully ${action}d ${data.success} items`);
            location.reload();
        } else {
            alert('Failed to update items');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update items');
    });
}

// Individual row actions
function approveItem(itemId) {
    updateItemStatus(itemId, 'approve');
}

function rejectItem(itemId) {
    updateItemStatus(itemId, 'reject');
}

function deleteItem(itemId) {
    if (confirm('Are you sure you want to delete this item?')) {
        updateItemStatus(itemId, 'delete');
    }
}

function updateItemStatus(itemId, action) {
    fetch('/admin/inventory-staging/batch-action', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            staging_ids: [itemId.toString()],
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success > 0) {
            // Reload the page to show updated status
            location.reload();
        } else {
            alert('Failed to update item');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update item');
    });
}

// Bulk approve all valid rows
function bulkApproveValid() {
    // Find all rows that don't have issues
    const validRows = document.querySelectorAll('tr:not(.has-missing-fields):not(.has-zero-cost):not(.is-duplicate)');
    const validIds = [];
    
    validRows.forEach(row => {
        const checkbox = row.querySelector('.item-select');
        if (checkbox && row.dataset.id) {
            // Check if not already approved
            const statusBadge = row.querySelector('.status-badge');
            if (statusBadge && !statusBadge.classList.contains('status-approved')) {
                validIds.push(row.dataset.id);
            }
        }
    });
    
    if (validIds.length === 0) {
        alert('No valid rows to approve');
        return;
    }
    
    if (!confirm(`Approve ${validIds.length} valid rows?`)) return;
    
    fetch('/admin/inventory-staging/batch-action', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            staging_ids: validIds,
            action: 'approve'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success > 0) {
            alert(`Successfully approved ${data.success} items`);
            location.reload();
        } else {
            alert('Failed to approve items');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to approve items');
    });
}

// Process to live
function processToLive() {
    const batch = document.getElementById('batchFilter').value;
    const message = batch 
        ? 'Process all approved items from this batch to live inventory?' 
        : 'Process ALL approved items to live inventory?';
    
    if (!confirm(message)) return;
    
    fetch('/admin/inventory-staging/process-to-live', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            batch_id: batch || null
        })
    })
    .then(response => response.json())
    .then(data => {
        alert(`Processed ${data.processed} items to live inventory. Errors: ${data.errors}`);
        if (data.details.length > 0) {
            console.log('Processing details:', data.details);
        }
        location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to process items');
    });
}

// Add keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + A to select all visible
    if ((e.ctrlKey || e.metaKey) && e.key === 'a' && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        document.querySelector('.select-all').click();
    }
    
    // Delete key to reject selected
    if (e.key === 'Delete' && selectedItems.size > 0 && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        bulkAction('reject');
    }
});
</script>
{% endblock %}