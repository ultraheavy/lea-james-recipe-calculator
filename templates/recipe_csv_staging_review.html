{% extends "base_modern.html" %}

{% block title %}Recipe CSV Staging Review{% endblock %}

{% block additional_css %}
<style>
    /* Recipe staging specific styles */
    .staging-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        background: var(--surface-light);
        border: 1px solid var(--border-color);
    }
    
    .stat-value {
        font-size: 2em;
        font-weight: bold;
        margin: 5px 0;
    }
    
    .recipe-row {
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .recipe-row:hover {
        background: var(--hover-bg);
    }
    
    .recipe-row.expanded {
        background: var(--surface-light);
    }
    
    .ingredient-details {
        background: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        display: none !important;
    }
    
    .ingredient-details.show {
        display: block !important;
    }
    
    .ingredient-table {
        width: 100%;
        margin-top: 10px;
    }
    
    .ingredient-table th {
        background: var(--surface-light);
        padding: 8px;
        text-align: left;
        font-size: 0.9em;
    }
    
    .ingredient-table td {
        padding: 8px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .prep-badge {
        background: #6f42c1;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.85em;
        margin-left: 8px;
    }
    
    .type-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.85em;
        margin-left: 8px;
    }
    
    .type-prep {
        background: #6f42c1;
        color: white;
    }
    
    .type-regular {
        background: #28a745;
        color: white;
    }
    
    .status-pending {
        background: #ffc107;
        color: #212529;
    }
    
    .status-approved {
        background: #28a745;
        color: white;
    }
    
    .status-rejected {
        background: #dc3545;
        color: white;
    }
    
    .editable {
        cursor: text;
        padding: 2px 4px;
        border-radius: 3px;
        transition: background 0.2s;
    }
    
    .editable:hover {
        background: var(--hover-bg);
    }
    
    .editable.editing {
        background: #fff;
        border: 1px solid var(--primary-color);
        outline: none;
    }
    
    .expand-icon {
        display: inline-block;
        width: 20px;
        transition: transform 0.2s;
    }
    
    .recipe-row.expanded .expand-icon {
        transform: rotate(90deg);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1 class="page-title">Recipe CSV Staging Review</h1>
        <div class="page-actions">
            <button onclick="reloadFromCSV()" class="btn btn-secondary">
                <i class="icon-refresh"></i> Reload from CSV
            </button>
            <button onclick="bulkApprove()" class="btn btn-primary">
                <i class="icon-check"></i> Bulk Approve Valid Recipes
            </button>
            <button onclick="processToLive()" class="btn btn-success">
                <i class="icon-upload"></i> Process to Live
            </button>
        </div>
    </div>

    <!-- Statistics -->
    <div class="staging-stats">
        <div class="stat-card">
            <div class="stat-label">Total Recipes</div>
            <div class="stat-value">{{ stats.recipes.total }}</div>
        </div>
        <div class="stat-card" style="background: #e7d4ff;">
            <div class="stat-label">Prep Recipes</div>
            <div class="stat-value">{{ stats.recipes.prep }}</div>
        </div>
        <div class="stat-card" style="background: #d4f1e8;">
            <div class="stat-label">Approved Items</div>
            <div class="stat-value">{{ stats.overall.approved }}</div>
        </div>
        <div class="stat-card" style="background: #ffe0e0;">
            <div class="stat-label">Needs Review</div>
            <div class="stat-value">{{ stats.overall.needs_review }}</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-section card">
        <form method="get" action="{{ url_for('recipe_csv_staging.index') }}">
            <div class="filter-grid">
                <div class="filter-group">
                    <label>Batch</label>
                    <select name="batch_id" class="form-control">
                        <option value="">All Batches</option>
                        {% for batch in batches %}
                        <option value="{{ batch.import_batch_id }}" {% if filters.batch_id == batch.import_batch_id %}selected{% endif %}>
                            {{ batch.import_batch_id }} ({{ batch.count }} recipes)
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Review Status</label>
                    <select name="review_status" class="form-control">
                        <option value="">All Statuses</option>
                        <option value="pending" {% if filters.review_status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="approved" {% if filters.review_status == 'approved' %}selected{% endif %}>Approved</option>
                        <option value="rejected" {% if filters.review_status == 'rejected' %}selected{% endif %}>Rejected</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Recipe Type</label>
                    <select name="is_prep_recipe" class="form-control">
                        <option value="">All Types</option>
                        <option value="1" {% if filters.is_prep_recipe %}selected{% endif %}>Prep Recipes Only</option>
                        <option value="0" {% if filters.is_prep_recipe == false %}selected{% endif %}>Regular Recipes Only</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" name="search" class="form-control" 
                           placeholder="Search recipes..." 
                           value="{{ filters.search or '' }}">
                </div>
                
                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                    <a href="{{ url_for('recipe_csv_staging.index') }}" class="btn btn-secondary">Clear</a>
                </div>
            </div>
        </form>
    </div>

    <!-- Recipe Table -->
    <div class="table-container card">
        <table class="data-table">
            <thead>
                <tr>
                    <th width="30"></th>
                    <th width="50">
                        <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)">
                    </th>
                    <th>Recipe Name</th>
                    <th>Ingredients</th>
                    <th>Total Cost</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for recipe in recipes %}
                <tr class="recipe-row" data-recipe="{{ recipe.recipe_name }}">
                    <td>
                        <span class="expand-icon">▶</span>
                    </td>
                    <td>
                        <input type="checkbox" class="recipe-checkbox" 
                               value="{{ recipe.recipe_name }}"
                               {% if recipe.needs_review %}disabled title="Cannot approve recipes with issues"{% endif %}>
                    </td>
                    <td>
                        <div class="editable" data-field="recipe_name">
                            {{ recipe.recipe_name }}
                        </div>
                    </td>
                    <td>
                        {{ recipe.ingredient_count }}
                        {% if recipe.prep_ingredient_count > 0 %}
                            <span class="prep-badge">{{ recipe.prep_ingredient_count }} prep</span>
                        {% endif %}
                    </td>
                    <td>${{ "%.2f"|format(recipe.total_cost or 0) }}</td>
                    <td>
                        {% if recipe.is_prep_recipe %}
                            <span class="type-badge type-prep">Prep Recipe</span>
                        {% else %}
                            <span class="type-badge type-regular">Recipe</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-badge status-{{ recipe.review_status }}">
                            {{ recipe.review_status|title }}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="approveRecipe('{{ recipe.recipe_name }}')" 
                                    class="btn btn-sm btn-success"
                                    {% if recipe.needs_review %}disabled{% endif %}>
                                ✓
                            </button>
                            <button onclick="rejectRecipe('{{ recipe.recipe_name }}')" 
                                    class="btn btn-sm btn-danger">
                                ✗
                            </button>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td colspan="8" style="padding: 0;">
                        <div class="ingredient-details" id="details-{{ recipe.recipe_name|replace(' ', '-') }}">
                            <!-- Ingredients will be loaded here -->
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% if total == 0 %}
        <div class="empty-state">
            <p>No recipes found matching your criteria.</p>
            <button onclick="reloadFromCSV()" class="btn btn-primary">Load Recipes from CSV</button>
        </div>
        {% endif %}
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="pagination">
        <!-- Pagination code here -->
    </div>
    {% endif %}
</div>

<script>
// Toggle recipe details
document.querySelectorAll('.recipe-row').forEach(row => {
    row.addEventListener('click', function(e) {
        // Don't toggle on checkbox or button click
        if (e.target.type === 'checkbox' || e.target.tagName === 'BUTTON') return;
        
        const recipeName = this.dataset.recipe;
        const detailsId = 'details-' + recipeName.replace(/ /g, '-');
        const details = document.getElementById(detailsId);
        
        if (this.classList.contains('expanded')) {
            this.classList.remove('expanded');
            details.classList.remove('show');
            // Clear the content when collapsing
            details.innerHTML = '';
        } else {
            this.classList.add('expanded');
            details.classList.add('show');
            loadIngredients(recipeName, detailsId);
        }
    });
});

// Load ingredients for a recipe
async function loadIngredients(recipeName, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '<p>Loading ingredients...</p>';
    
    try {
        const response = await fetch(`/admin/recipe-csv-staging/recipe/${encodeURIComponent(recipeName)}/ingredients`);
        const data = await response.json();
        
        if (data.ingredients && data.ingredients.length > 0) {
            let html = '<table class="ingredient-table">';
            html += '<thead><tr>';
            html += '<th>Ingredient</th><th>Quantity</th><th>Unit</th><th>Cost</th><th>Category</th><th>Type</th>';
            html += '</tr></thead><tbody>';
            
            data.ingredients.forEach(ing => {
                html += '<tr>';
                html += `<td><span class="editable" data-field="ingredient_name" data-id="${ing.staging_id}">${ing.ingredient_name || ''}</span></td>`;
                html += `<td><span class="editable" data-field="quantity" data-id="${ing.staging_id}">${ing.quantity || ''}</span></td>`;
                html += `<td><span class="editable" data-field="unit" data-id="${ing.staging_id}">${ing.unit || ''}</span></td>`;
                html += `<td><span class="editable" data-field="cost" data-id="${ing.staging_id}">$${ing.cost || '0.00'}</span></td>`;
                html += `<td>${ing.category || ''}</td>`;
                html += `<td>${ing.used_as_ingredient ? 'Prep Recipe' : 'Inventory'}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            
            // Enable inline editing
            enableInlineEditing(container);
        }
    } catch (error) {
        container.innerHTML = '<p class="error">Failed to load ingredients</p>';
    }
}

// Enable inline editing
function enableInlineEditing(container) {
    container.querySelectorAll('.editable').forEach(element => {
        element.addEventListener('click', function() {
            if (this.classList.contains('editing')) return;
            
            const originalValue = this.textContent;
            const field = this.dataset.field;
            const id = this.dataset.id;
            
            this.contentEditable = true;
            this.classList.add('editing');
            this.focus();
            
            // Select all text
            const range = document.createRange();
            range.selectNodeContents(this);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
            
            const saveChanges = async () => {
                const newValue = this.textContent.trim();
                if (newValue !== originalValue) {
                    try {
                        const response = await fetch(`/admin/recipe-csv-staging/item/${id}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({[field]: newValue})
                        });
                        
                        if (!response.ok) {
                            throw new Error('Update failed');
                        }
                    } catch (error) {
                        alert('Failed to save changes');
                        this.textContent = originalValue;
                    }
                }
                
                this.contentEditable = false;
                this.classList.remove('editing');
            };
            
            this.addEventListener('blur', saveChanges, {once: true});
            this.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.blur();
                } else if (e.key === 'Escape') {
                    this.textContent = originalValue;
                    this.blur();
                }
            });
        });
    });
}

// Bulk operations
function toggleSelectAll(checkbox) {
    document.querySelectorAll('.recipe-checkbox:not(:disabled)').forEach(cb => {
        cb.checked = checkbox.checked;
    });
}

async function bulkApprove() {
    const selected = Array.from(document.querySelectorAll('.recipe-checkbox:checked'))
        .map(cb => cb.value);
    
    if (selected.length === 0) {
        alert('Please select recipes to approve');
        return;
    }
    
    if (confirm(`Approve ${selected.length} recipes?`)) {
        // Implementation here
        location.reload();
    }
}

async function processToLive() {
    if (confirm('Process all approved recipes to live tables?')) {
        const response = await fetch('/admin/recipe-csv-staging/process-to-live', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        });
        
        const result = await response.json();
        if (result.success) {
            alert(`Successfully processed ${result.processed} recipes`);
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    }
}

async function reloadFromCSV() {
    if (confirm('Reload all recipes from CSV files? This will clear existing staging data.')) {
        const response = await fetch('/admin/recipe-csv-staging/refresh-data', {
            method: 'POST'
        });
        
        const result = await response.json();
        if (result.success) {
            alert(result.message);
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    }
}

// Recipe-level actions
async function approveRecipe(recipeName) {
    try {
        const response = await fetch(`/admin/recipe-csv-staging/recipe/${encodeURIComponent(recipeName)}/approve`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await response.json();
        if (result.success) {
            // Reload the page to show updated status
            location.reload();
        } else {
            alert('Error approving recipe: ' + result.message);
        }
    } catch (error) {
        alert('Error approving recipe: ' + error.message);
    }
}

async function rejectRecipe(recipeName) {
    const reason = prompt('Rejection reason (optional):');
    if (reason === null) return; // User cancelled
    
    try {
        const response = await fetch(`/admin/recipe-csv-staging/recipe/${encodeURIComponent(recipeName)}/reject`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({reason: reason || 'Rejected by admin'})
        });
        
        const result = await response.json();
        if (result.success) {
            // Reload the page to show updated status
            location.reload();
        } else {
            alert('Error rejecting recipe: ' + result.message);
        }
    } catch (error) {
        alert('Error rejecting recipe: ' + error.message);
    }
}
</script>
{% endblock %}