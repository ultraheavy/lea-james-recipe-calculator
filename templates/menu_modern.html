{% extends "base_modern.html" %}

{% block title %}Menu Items - Lea Jane's Recipe Calculator{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <!-- Page Header -->
    <div class="flex flex-col gap-4 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-semibold mb-2">Menu Management</h1>
                <p class="text-secondary">{{ menu_items|length }} items across all versions</p>
            </div>
            <div class="flex gap-3">
                <a href="/menu/versions" class="btn btn-secondary">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    Manage Versions
                </a>
                <a href="/menu/compare" class="btn btn-secondary">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 4H6v16m12 0H6m12 0l-3-3m3 3l-3 3"/>
                    </svg>
                    Compare
                </a>
                <a href="/menu/items/add" class="btn btn-primary">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14m-7-7h14"/>
                    </svg>
                    Add Recipe to Menu
                </a>
            </div>
        </div>
        
        <!-- Version Selector and Search -->
        <div class="card">
            <div class="card-body">
                <div class="grid grid-cols-1 grid-cols-3 gap-4">
                    <div class="form-group m-0">
                        <label class="form-label text-sm">Menu Version</label>
                        <select class="form-control" id="versionSelect" onchange="changeVersion()">
                            {% for version in menu_versions %}
                            <option value="{{ version.id }}" {% if version.id == current_version_id %}selected{% endif %}>
                                {{ version.version_name }}
                                {% if version.is_active %}(Active){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group m-0">
                        <label class="form-label text-sm">Search</label>
                        <input type="text" 
                               class="form-control" 
                               id="searchInput" 
                               placeholder="Search menu items..."
                               onkeyup="filterMenu()">
                    </div>
                    <div class="form-group m-0">
                        <label class="form-label text-sm">Menu Group</label>
                        <select class="form-control" id="groupFilter" onchange="filterMenu()">
                            <option value="">All Groups</option>
                            {% set groups = [] %}
                            {% for item in menu_items %}
                                {% if item.menu_group and item.menu_group not in groups %}
                                    <option value="{{ item.menu_group }}">{{ item.menu_group }}</option>
                                    {% set _ = groups.append(item.menu_group) %}
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bulk Actions Bar -->
        <div class="bulk-actions-bar" id="bulkActionsBar" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <span class="text-sm font-medium">
                                <span id="selectedCount">0</span> items selected
                            </span>
                            <button class="btn btn-sm btn-secondary" onclick="selectAllItems()">
                                Select All
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="clearSelection()">
                                Clear Selection
                            </button>
                        </div>
                        <div class="flex items-center gap-3">
                            <select class="form-control form-control-sm" id="bulkAction">
                                <option value="">Choose action...</option>
                                <option value="activate">Activate Items</option>
                                <option value="deactivate">Deactivate Items</option>
                                <option value="change-menu">Move to Menu</option>
                                <option value="copy-version">Copy to Version</option>
                                <option value="update-prices">Update Prices</option>
                                <option value="delete">Delete Items</option>
                            </select>
                            <button class="btn btn-sm btn-primary" onclick="executeBulkAction()">
                                Apply Action
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Menu Items Table -->
    <div class="table-container">
        <table class="table table-striped" id="menuTable">
            <thead>
                <tr>
                    <th class="checkbox-column">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    </th>
                    <th>Menu Item</th>
                    <th>Group</th>
                    <th>Recipe</th>
                    <th>Menu Price</th>
                    <th>Food Cost</th>
                    <th>Cost %</th>
                    <th>Profit</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in menu_items %}
                <tr data-name="{{ item.item_name|lower }}"
                    data-group="{{ item.menu_group|lower }}"
                    data-recipe="{{ item.recipe_name|lower }}"
                    data-item-id="{{ item.id }}">
                    <td class="checkbox-column">
                        <input type="checkbox" class="item-checkbox" value="{{ item.id }}" onchange="updateSelection()">
                    </td>
                    <td>
                        <div class="flex items-center gap-3">
                            <div class="icon-container"></div>
                            <div>
                                <p class="font-medium">{{ item.item_name }}</p>
                                {% if item.item_description %}
                                <p class="text-sm text-secondary">{{ item.item_description }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge badge-info">{{ item.menu_group or '-' }}</span>
                    </td>
                    <td>
                        {% if item.recipe_name %}
                        <a href="/recipes/{{ item.recipe_id }}" class="text-primary text-sm">
                            {{ item.recipe_name }}
                        </a>
                        {% else %}
                        <span class="text-secondary text-sm">No recipe</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="font-semibold">${{ "%.2f"|format(item.menu_price or 0) }}</span>
                    </td>
                    <td>
                        <span class="text-sm text-secondary">${{ "%.2f"|format(item.food_cost or item.recipe_food_cost or 0) }}</span>
                    </td>
                    <td>
                        {% set cost = item.food_cost or item.recipe_food_cost or 0 %}
                        {% set price = item.menu_price or 0 %}
                        {% if price > 0 %}
                            {% set cost_percent = (cost / price * 100) %}
                            <span class="font-medium {% if cost_percent > 35 %}text-danger{% elif cost_percent > 30 %}text-warning{% else %}text-success{% endif %}">
                                {{ "%.1f"|format(cost_percent) }}%
                            </span>
                        {% else %}
                            <span class="text-secondary">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if price > 0 %}
                            <span class="font-semibold text-success">${{ "%.2f"|format(price - cost) }}</span>
                        {% else %}
                            <span class="text-secondary">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge {% if item.status == 'Active' %}badge-success{% else %}badge-warning{% endif %}">
                            {{ item.status or 'Active' }}
                        </span>
                    </td>
                    <td>
                        <div class="flex gap-2">
                            <a href="/menu/items/edit/{{ item.id }}" 
                               class="btn btn-sm btn-secondary"
                               title="Edit">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </a>
                            <form method="POST" action="/menu/items/delete/{{ item.id }}" 
                                  class="inline" 
                                  onsubmit="return confirm('Remove {{ item.item_name }} from this menu?');">
                                <button type="submit" 
                                        class="btn btn-sm btn-danger"
                                        title="Remove">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 6h18m-2 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if not menu_items %}
    <div class="card">
        <div class="card-body text-center p-8">
            <div class="food-icon food-icon-lg icon-sauce mx-auto mb-4">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="4" y="4" width="16" height="16" rx="2"/>
                    <path d="M9 9h6M9 15h6M12 9v6"/>
                </svg>
            </div>
            <h3 class="text-xl font-semibold mb-2">No menu items yet</h3>
            <p class="text-secondary mb-4">Menu items are created from your recipes</p>
            <a href="/recipes" class="btn btn-primary">Go to Recipes</a>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Initialize category icons
document.addEventListener('DOMContentLoaded', function() {
    const rows = document.querySelectorAll('#menuTable tbody tr');
    rows.forEach(row => {
        const group = row.getAttribute('data-group');
        const recipe = row.getAttribute('data-recipe');
        const iconContainer = row.querySelector('.icon-container');
        if (iconContainer) {
            // Use recipe name or group for category detection
            const icon = createFoodIcon(recipe || group || 'misc', 'sm');
            iconContainer.appendChild(icon);
        }
    });
});

function changeVersion() {
    const versionId = document.getElementById('versionSelect').value;
    window.location.href = `/menu?version_id=${versionId}`;
}

function filterMenu() {
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    const groupFilter = document.getElementById('groupFilter').value.toLowerCase();
    const rows = document.querySelectorAll('#menuTable tbody tr');
    
    rows.forEach(row => {
        const name = row.getAttribute('data-name') || '';
        const group = row.getAttribute('data-group') || '';
        const recipe = row.getAttribute('data-recipe') || '';
        
        const matchesSearch = !searchInput || 
            name.includes(searchInput) || 
            group.includes(searchInput) ||
            recipe.includes(searchInput);
            
        const matchesGroup = !groupFilter || group === groupFilter;
        
        if (matchesSearch && matchesGroup) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Bulk operations functions
let selectedItems = new Set();

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.item-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        if (selectAll.checked) {
            selectedItems.add(checkbox.value);
        } else {
            selectedItems.delete(checkbox.value);
        }
    });
    
    updateSelection();
}

function updateSelection() {
    selectedItems.clear();
    const checkboxes = document.querySelectorAll('.item-checkbox:checked');
    
    checkboxes.forEach(checkbox => {
        selectedItems.add(checkbox.value);
    });
    
    const selectAll = document.getElementById('selectAll');
    const allCheckboxes = document.querySelectorAll('.item-checkbox');
    selectAll.checked = selectedItems.size === allCheckboxes.length && allCheckboxes.length > 0;
    selectAll.indeterminate = selectedItems.size > 0 && selectedItems.size < allCheckboxes.length;
    
    // Show/hide bulk actions bar
    const bulkBar = document.getElementById('bulkActionsBar');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedItems.size > 0) {
        bulkBar.style.display = 'block';
        selectedCount.textContent = selectedItems.size;
    } else {
        bulkBar.style.display = 'none';
    }
}

function selectAllItems() {
    const checkboxes = document.querySelectorAll('.item-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
        selectedItems.add(checkbox.value);
    });
    document.getElementById('selectAll').checked = true;
    updateSelection();
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('.item-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('selectAll').checked = false;
    selectedItems.clear();
    updateSelection();
}

function executeBulkAction() {
    const action = document.getElementById('bulkAction').value;
    if (!action) {
        alert('Please select an action');
        return;
    }
    
    if (selectedItems.size === 0) {
        alert('Please select at least one item');
        return;
    }
    
    const itemIds = Array.from(selectedItems);
    
    switch(action) {
        case 'activate':
        case 'deactivate':
            updateItemStatus(itemIds, action === 'activate');
            break;
        
        case 'change-menu':
            showMenuDialog(itemIds);
            break;
            
        case 'copy-version':
            showVersionDialog(itemIds);
            break;
            
        case 'update-prices':
            showPriceDialog(itemIds);
            break;
            
        case 'delete':
            if (confirm(`Are you sure you want to delete ${itemIds.length} items?`)) {
                deleteItems(itemIds);
            }
            break;
    }
}

function updateItemStatus(itemIds, activate) {
    const status = activate ? 'active' : 'inactive';
    fetch('/api/menu/bulk-update-status', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({item_ids: itemIds, status: status})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${itemIds.length} items ${activate ? 'activated' : 'deactivated'}`);
            location.reload();
        }
    });
}

function showMenuDialog(itemIds) {
    const menu = prompt('Enter the menu name to move items to:');
    if (menu) {
        fetch('/api/menu/bulk-change-menu', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({item_ids: itemIds, menu_name: menu})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`${itemIds.length} items moved to ${menu}`);
                location.reload();
            }
        });
    }
}

function showVersionDialog(itemIds) {
    const versionId = prompt('Enter the version ID to copy items to:');
    if (versionId) {
        fetch('/api/menu/bulk-copy-version', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({item_ids: itemIds, version_id: versionId})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`${itemIds.length} items copied to version`);
                location.reload();
            }
        });
    }
}

function showPriceDialog(itemIds) {
    const adjustment = prompt('Enter price adjustment (e.g., +1.00, -0.50, *1.1):');
    if (adjustment) {
        fetch('/api/menu/bulk-update-prices', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({item_ids: itemIds, adjustment: adjustment})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`${itemIds.length} items prices updated`);
                location.reload();
            }
        });
    }
}

function deleteItems(itemIds) {
    fetch('/api/menu/bulk-delete', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({item_ids: itemIds})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${itemIds.length} items deleted`);
            location.reload();
        }
    });
}
</script>

<style>
    .checkbox-column {
        width: 40px;
        text-align: center;
    }
    
    .checkbox-column input[type="checkbox"] {
        cursor: pointer;
    }
    
    .bulk-actions-bar {
        position: sticky;
        top: 70px;
        z-index: 10;
        margin-bottom: 1rem;
    }
    
    .form-control-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        line-height: 1.5;
        border-radius: 0.25rem;
    }
    
    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        line-height: 1.5;
        border-radius: 0.25rem;
    }
    
    @media (max-width: 768px) {
        .table-container {
            margin: 0 -1rem;
        }
        
        /* Hide less important columns on mobile */
        #menuTable th:nth-child(3),
        #menuTable td:nth-child(3),
        #menuTable th:nth-child(7),
        #menuTable td:nth-child(7) {
            display: none;
        }
    }
</style>
{% endblock %}